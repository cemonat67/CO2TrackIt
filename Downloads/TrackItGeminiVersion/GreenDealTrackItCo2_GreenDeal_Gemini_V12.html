<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CO₂ TrackIt | Green Deal Uyumlu Karbon Hesaplayıcı</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <!-- Firebase SDK Eklentileri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase yapılandırması ve uygulama kimliği global değişkenlerden alınır
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Firebase uygulamasını başlat
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global erişim için değişkenleri window objesine ekle
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.appId = appId; // appId'yi de global yapalım

        // Kullanıcı kimlik doğrulama durumu değiştiğinde çalışacak fonksiyon
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Kullanıcı oturum açmışsa, userId'yi ayarla
                window.userId = user.uid;
                document.getElementById('userIdDisplay').textContent = `Kullanıcı ID: ${window.userId}`;
                console.log("Firebase Auth Ready. User ID:", window.userId);
                // Kullanıcı oturum açtıktan sonra siparişleri yükle
                window.loadOrdersFromFirestore(); // Global fonksiyonu çağır
            } else {
                // Kullanıcı oturum açmamışsa, anonim olarak oturum açmayı dene
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    document.getElementById('userIdDisplay').textContent = `Oturum Açılamadı: ${error.message}`;
                    // Hata durumunda da siparişleri yüklemeyi deneyebiliriz, ancak veri kaydedilemez
                    window.loadOrdersFromFirestore(); // Global fonksiyonu çağır
                }
            }
        });

        /**
         * Siparişi Firestore'a kaydeder.
         * @param {object} orderData - Kaydedilecek sipariş verisi.
         */
        window.saveOrderToFirestore = async (orderData) => {
            if (!window.userId) {
                console.warn("Kullanıcı kimliği mevcut değil, sipariş kaydedilemiyor.");
                window.showMessage("Hata", "Sipariş kaydedilemedi. Lütfen internet bağlantınızı kontrol edin veya sayfayı yenileyin.", "error");
                return;
            }
            try {
                // Kullanıcıya özel koleksiyona kaydet
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${window.userId}/carbonOrders`), {
                    ...orderData,
                    timestamp: serverTimestamp() // Sunucu zaman damgası ekle
                });
                console.log("Sipariş Firestore'a kaydedildi, ID: ", docRef.id);
            } catch (e) {
                console.error("Firestore'a sipariş eklenirken hata oluştu: ", e);
                window.showMessage("Hata", "Sipariş kaydedilirken bir hata oluştu: " + e.message, "error");
            }
        };

        /**
         * Firestore'dan siparişleri gerçek zamanlı olarak yükler.
         */
        window.loadOrdersFromFirestore = () => {
            if (!window.userId) {
                console.warn("Kullanıcı kimliği mevcut değil, siparişler yüklenemiyor.");
                return;
            }
            // `orderBy` kullanmaktan kaçınıyoruz, veriyi çektikten sonra JS'de sıralayacağız.
            const q = collection(db, `artifacts/${appId}/users/${window.userId}/carbonOrders`);

            onSnapshot(q, (snapshot) => {
                const fetchedOrders = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Firestore timestamp objesini okunabilir string'e çevir
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('tr-TR') : 'N/A';
                    fetchedOrders.push({ id: doc.id, ...data, timestamp: timestamp });
                });
                // Global orders dizisini güncelle
                window.orders = fetchedOrders;
                window.displayOrders(); // Global fonksiyonu çağır
                console.log("Siparişler Firestore'dan yüklendi:", fetchedOrders);
            }, (error) => {
                console.error("Firestore'dan siparişler yüklenirken hata oluştu: ", error);
                window.showMessage("Hata", "Siparişler yüklenirken bir hata oluştu: " + error.message, "error");
            });
        };

    </script>
    <style>
        /* CSS Değişkenleri */
        :root {
            --primary-green: #2E7D32;
            --secondary-green: #4CAF50;
            --light-green: #81C784;
            --accent-green: #66BB6A;
            --dark-green: #1B5E20;
            --success-green: #388E3C;
            --warning-orange: #FF9800;
            --error-red: #D32F2F;
            --text-dark: #212121;
            --text-light: #757575;
            --bg-light: #f8f9fa;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Genel Stil Ayarları */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Başlık Bölümü */
        .header {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: white;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            margin: 10px 0;
            opacity: 0.9;
        }

        .header .logo {
            max-width: 150px; /* Logo boyutunu ayarla */
            height: auto;
            margin-bottom: 15px;
        }
        .user-id-display {
            font-size: 0.85rem;
            margin-top: 10px;
            opacity: 0.7;
        }

        /* Kart Stilleri */
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--light-green), var(--accent-green));
            color: white;
            padding: 20px 30px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .card-body {
            padding: 30px;
        }

        /* Form Elemanları */
        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }

        /* Validasyon Stil Sınıfları */
        .form-control.is-invalid, .form-select.is-invalid {
            border-color: var(--error-red);
            padding-right: calc(1.5em + .75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23D32F2F'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle r='.5' cx='6' cy='8.2'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(.375em + .1875rem) center;
            background-size: calc(.75em + .375rem) calc(.75em + .375rem);
        }
        .form-control.is-valid, .form-select.is-valid {
            border-color: var(--success-green);
            padding-right: calc(1.5em + .75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23388E3C' d='M2.3 6.7L0 4.4 1.4 3 2.3 3.9 6.7 0 8.1 1.4z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(.375em + .1875rem) center;
            background-size: calc(.75em + .375rem) calc(.75em + .375rem);
        }

        /* Buton Stilleri */
        .btn {
            border-radius: 12px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary { background: linear-gradient(135deg, var(--secondary-green), var(--success-green)); border: none; color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, var(--success-green), var(--primary-green)); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #5a6268); border: none; color: white; }
        .btn-secondary:hover { background: linear-gradient(135deg, #5a6268, #495057); transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, var(--success-green), var(--primary-green)); border: none; }
        .btn-info { background: linear-gradient(135deg, #17a2b8, #138496); border: none; }
        .btn-dark { background: linear-gradient(135deg, #343a40, #23272b); border: none; color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning-orange), #f57c00); border: none; }

        /* Hata Mesajları ve Animasyon */
        .error { color: var(--error-red); font-size: 0.9rem; margin-top: 5px; display: none; animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .form-check-input:checked { background-color: var(--secondary-green); border-color: var(--secondary-green); }

        /* Sonuç Vurgulama */
        .result-highlight { background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border: 2px solid var(--light-green); border-radius: 15px; padding: 20px; margin: 20px 0; text-align: center; }
        .result-highlight h3 { color: var(--primary-green); font-size: 1.8rem; margin-bottom: 10px; }

        /* Grafik Konteyneri */
        .chart-container { background: white; border-radius: 15px; padding: 20px; box-shadow: var(--shadow); margin: 20px 0; }

        /* Metrik Izgarası */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: var(--shadow); transition: transform 0.3s ease; }
        .metric-card:hover { transform: translateY(-5px); }
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary-green); }
        .metric-label { color: var(--text-light); font-size: 0.9rem; }

        /* Sipariş Geçmişi Öğesi */
        .order-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--secondary-green); box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .order-item:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }

        /* Uyumluluk Rozeti */
        .compliance-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .compliance-good { background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; }
        .compliance-warning { background: linear-gradient(135deg, #FF9800, #FFA726); color: white; }
        .compliance-error { background: linear-gradient(135deg, #F44336, #EF5350); color: white; }

        /* Yükleme Animasyonu */
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Karışım Giriş Grubu */
        .blend-input-group { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--light-green); }
        
        /* Sürdürülebilirlik Skoru Çubuğu */
        .sustainability-score { background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border-radius: 15px; padding: 20px; margin: 20px 0; }
        .score-bar { width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .score-fill { height: 100%; background: linear-gradient(90deg, var(--error-red), var(--warning-orange), var(--secondary-green)); transition: width 0.5s ease; }
        
        /* Alt Bilgi */
        footer { text-align: center; padding: 30px 0; color: var(--text-light); font-size: 0.9rem; }

        /* Duyarlı Tasarım (Responsive) */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 2rem; }
            .card-body { padding: 20px; }
            .metrics-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="RabateksLogo.jpg" alt="Rabateks Logo" class="logo">
            <h1>🌱 CO₂ TrackIt</h1>
            <p>Green Deal Uyumlu Karbon Hesaplayıcı</p>
            <p>Üretim süreçlerinizin çevresel etkisini hesaplayın ve sürdürülebilirlik performansınızı iyileştirin</p>
            <p><strong>Rabateks</strong> | <a href="https://rabateks.com" target="_blank" style="color: #fff; text-decoration: underline;">rabateks.com</a></p>
            <p id="userIdDisplay" class="user-id-display">Kullanıcı ID: Yükleniyor...</p>
        </header>

        <div class="card">
            <div class="card-header">📊 Sipariş Bilgileri</div>
            <div class="card-body">
                <p class="text-muted">AB Yeşil Mutabakatı kriterlerine uygun olarak güncellenmiştir. Geri dönüşüm oranı ve Scope 3 emisyonları dahildir.</p>
                <form id="carbonForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="orderId" class="form-label">Sipariş ID</label>
                            <input type="text" class="form-control" id="orderId" required>
                            <div class="error" id="orderIdError">Sipariş ID boş olamaz.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productType" class="form-label">Ürün Tipi</label>
                            <select class="form-select" id="productType" required>
                                <option value="">Ürün Seçin</option>
                                <option value="Konfeksiyon">Konfeksiyon</option>
                                <option value="Kumaş">Kumaş</option>
                                <option value="İplik">İplik</option>
                            </select>
                            <div class="error" id="productTypeError">Lütfen bir ürün tipi seçin.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fabricType" class="form-label">Kumaş Tipi</label>
                            <select class="form-select" id="fabricType">
                                <option value="">Kumaş Tipi Seçin</option>
                                <option value="Dokuma">Dokuma</option>
                                <option value="Düz Örme">Düz Örme</option>
                                <option value="Yuvarlak Örme">Yuvarlak Örme</option>
                                <option value="Dokusuz">Dokusuz (Non-woven)</option>
                            </select>
                            <div class="error" id="fabricTypeError">Konfeksiyon veya kumaş ürünleri için kumaş tipi seçmelisiniz.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="material" class="form-label">Hammadde</label>
                            <select class="form-select" id="material" required>
                                <option value="">Hammadde Seçin</option>
                                <option value="PES">PES (Polyester)</option>
                                <option value="rPES">rPES (Geri Dönüştürülmüş Polyester)</option>
                                <option value="PA">PA (Polyamid/Naylon)</option>
                                <option value="CO">CO (Pamuk)</option>
                                <option value="rCO">rCO (Geri Dönüştürülmüş Pamuk)</option>
                                <option value="WO">WO (Yün)</option>
                                <option value="PAN">PAN (Akrilik)</option>
                                <option value="PP">PP (Polipropilen)</option>
                                <option value="LI">LI (Keten)</option>
                                <option value="SE">SE (İpek)</option>
                                <option value="VI">VI (Viskoz)</option>
                                <option value="CUP">CUP (Kupro)</option>
                                <option value="CMD">CMD (Modal)</option>
                                <option value="CLY">CLY (Lyocell)</option>
                                <option value="EL">EL (Elastane)</option>
                                <option value="SP">SP (Spandex)</option>
                                <option value="LY">LY (Lycra)</option>
                                <option value="Karışım">Karışım (Özel)</option>
                            </select>
                            <div class="error" id="materialError">Lütfen bir hammadde seçin.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="materialOrigin" class="form-label">Hammadde Menşei</label>
                            <select class="form-select" id="materialOrigin">
                                <option value="TR">Türkiye (Yerli)</option>
                                <option value="EU">Avrupa Birliği</option>
                                <option value="CN">Çin</option>
                                <option value="US">ABD</option>
                                <option value="Other">Diğer</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productionTech" class="form-label">Üretim Teknolojisi</label>
                            <select class="form-select" id="productionTech">
                                <option value="standard">Standart Teknoloji</option>
                                <option value="bat">Mümkün Olan En İyi Teknoloji (BAT)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3" id="blendSection" style="display: none;">
                        <label class="form-label">Karışım Oranları (%)</label>
                        <div id="blendInputs"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addBlendInput()"><i>+</i> Malzeme Ekle</button>
                        <div class="error" id="blendError">Toplam oran %100 olmalıdır!</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="unit" class="form-label">Birim</label>
                            <select class="form-select" id="unit" required>
                                <option value="">Birim Seçin</option>
                                <option value="Kg">Kg</option>
                                <option value="Mt">Mt (Metre)</option>
                                <option value="Yrd">Yrd (Yarda)</option>
                                <option value="Pcs">Pcs (Adet)</option>
                            </select>
                            <div class="error" id="unitError">Lütfen bir birim seçin.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="quantity" class="form-label">Miktar</label>
                            <input type="number" class="form-control" id="quantity" min="0" step="0.01" required>
                            <div class="error" id="quantityError">Miktar pozitif bir sayı olmalıdır.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">İşlem Türü (Çoklu Seçim)</label>
                        <div class="row">
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processBoyama"><label class="form-check-label" for="processBoyama">Boyama</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processBaski"><label class="form-check-label" for="processBaski">Baskı</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processApre"><label class="form-check-label" for="processApre">Apre</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processDokuma"><label class="form-check-label" for="processDokuma">Dokuma</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processOrme"><label class="form-check-label" for="processOrme">Örme</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processKesim"><label class="form-check-label" for="processKesim">Kesim</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processDikim"><label class="form-check-label" for="processDikim">Dikim</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processBitis"><label class="form-check-label" for="processBitis">Bitiş İşlemleri</label></div></div>
                        </div>
                        <div class="error" id="processError">Lütfen en az bir işlem türü seçin.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="electricity" class="form-label">Elektrik Tüketimi (kWh)</label><input type="number" class="form-control" id="electricity" min="0" step="0.01"><div class="error" id="electricityError">Elektrik tüketimi negatif olamaz.</div></div>
                        <div class="col-md-6 mb-3"><label for="water" class="form-label">Su Tüketimi (Litre)</label><input type="number" class="form-control" id="water" min="0" step="0.01"><div class="error" id="waterError">Su tüketimi negatif olamaz.</div></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="steam" class="form-label">Buhar Tüketimi (kg)</label><input type="number" class="form-control" id="steam" min="0" step="0.01"><div class="error" id="steamError">Buhar tüketimi negatif olamaz.</div></div>
                        <div class="col-md-6 mb-3"><label for="gas" class="form-label">Doğalgaz Tüketimi (m³)</label><input type="number" class="form-control" id="gas" min="0" step="0.01"><div class="error" id="gasError">Doğalgaz tüketimi negatif olamaz.</div></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="transport" class="form-label">Taşıma Mesafesi (km)</label><input type="number" class="form-control" id="transport" min="0" step="0.01"><div class="error" id="transportError">Taşıma mesafesi negatif olamaz.</div></div>
                        <div class="col-md-6 mb-3"><label for="recycledContent" class="form-label">Geri Dönüştürülmüş İçerik (%)</label><input type="number" class="form-control" id="recycledContent" min="0" max="100" step="0.01"><div class="error" id="recycledContentError">Geri dönüştürülmüş içerik 0 ile 100 arasında olmalıdır.</div><small class="form-text text-muted">AB 2030 hedefi: %50 geri dönüştürülmüş içerik</small></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Sürdürülebilir İşlemler (Çoklu Seçim)</label>
                        <div class="row">
                            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="sustainableWaterless"><label class="form-check-label" for="sustainableWaterless">Su Kullanmayan Boyama</label></div></div>
                            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="sustainableDigital"><label class="form-check-label" for="sustainableDigital">Dijital Baskı</label></div></div>
                            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="sustainableRenewable"><label class="form-check-label" for="sustainableRenewable">Yenilenebilir Enerji</label></div></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary me-2">🔍 CO₂ Emisyonlarını Hesapla</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">🔄 Sıfırla</button>
                    </div>
                </form>
                <div class="loading" id="loading"><div class="spinner"></div><p>Hesaplanıyor...</p></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">📈 Karbon Ayak İzi Sonuçları</div>
            <div class="card-body">
                <div class="result-highlight">
                    <h3>Toplam CO₂ Emisyonu: <span id="totalEmission">0.00 kg</span></h3>
                    <p id="treeEquivalent">Bu miktar, 0 ağacın bir yılda temizleyebileceği CO₂ miktarına eşdeğerdir.</p>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-value" id="electricityEmission">0.00</div><div class="metric-label">Elektrik Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="waterEmission">0.00</div><div class="metric-label">Su Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="steamEmission">0.00</div><div class="metric-label">Buhar Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="gasEmission">0.00</div><div class="metric-label">Doğalgaz Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="transportEmission">0.00</div><div class="metric-label">Taşıma Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="materialEmission">0.00</div><div class="metric-label">Hammadde Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="processEmission">0.00</div><div class="metric-label">İşlem Emisyonu (kg)</div></div>
                </div>
                <div class="row"><div class="col-md-6"><div class="mb-3"><label for="chartType" class="form-label">Grafik Türü</label><select class="form-select" id="chartType" onchange="window.updateChart()"><option value="bar">Çubuk Grafik</option><option value="pie">Pasta Grafik</option><option value="doughnut">Halka Grafik</option><option value="line">Çizgi Grafik</option></select></div></div></div>
                <div class="chart-container"><canvas id="emissionChart"></canvas></div>
                <div class="sustainability-score"><h4>🌱 Sürdürülebilirlik Skoru</h4><div class="score-bar"><div class="score-fill" id="sustainabilityBar" style="width: 0%"></div></div><p>Sürdürülebilirlik Skoru: <span id="sustainabilityScore">0/100</span></p></div>
                <div class="row">
                    <div class="col-md-6"><h4>🇪🇺 AB Uyumluluk Raporu</h4><p>EU Taxonomy Uyumu: <span id="taxonomyCompliance" class="compliance-badge">Hesaplanıyor...</span></p><p>Geri Dönüşüm Skoru: <span id="recycleScore">0/100</span></p><p><strong>Öneriler:</strong> <span id="suggestions">-</span></p></div>
                    <div class="col-md-6"><h4>📊 Detaylı Analiz</h4><p>Birim Başına Emisyon: <span id="unitEmission">0.00 kg/birim</span></p><p>Sektör Ortalaması: <span id="sectorAverage">-</span></p><p>Performans: <span id="performanceRating" class="compliance-badge">-</p></div>
                </div>
                <div class="card mt-4">
                    <div class="card-header" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">💡 Simülasyon Laboratuvarı</div>
                    <div class="card-body">
                        <p>Farklı senaryoların karbon ayak izinize etkisini anında görün.</p>
                        <div class="row align-items-center">
                            <div class="col-md-5"><select id="simulationType" class="form-select"><option value="">Simülasyon Türü Seçin</option><option value="recycle">Geri Dönüşüm Oranını Değiştir</option><option value="energy">Yenilenebilir Enerjiye Geç</option></select></div>
                            <div class="col-md-5"><input type="number" id="simulationValue" class="form-control" placeholder="Değer Girin (%)" style="display:none;"></div>
                            <div class="col-md-2"><button class="btn btn-info w-100" onclick="window.runSimulation()">Simüle Et</button></div>
                        </div>
                        <div id="simulationResult" class="result-highlight mt-3" style="display:none; background: linear-gradient(135deg, #e3f2fd, #f1f8e9);"></div>
                    </div>
                </div>
                <div class="text-center my-4">
                    <button class="btn btn-success me-2" onclick="window.exportReport()">📄 Raporu Dışa Aktar</button>
                    <button class="btn btn-info me-2" onclick="window.checkCompliance()">✅ Uyumluluk Kontrolü</button>
                    <button class="btn btn-warning me-2" onclick="window.generateEUReport()">🇪🇺 AB Raporu</button>
                    <button class="btn btn-dark" onclick="window.generateDPP()">📄 Dijital Pasaport Oluştur (JSON)</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">🗂️ Sipariş Geçmişi</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8"><select class="form-select" id="orderFilter" onchange="window.filterOrders()"><option value="">Tüm Siparişler</option><option value="Konfeksiyon">Konfeksiyon</option><option value="Kumaş">Kumaş</option><option value="İplik">İplik</option><option value="Düşük Emisyon">Düşük Emisyon (<50kg)</option><option value="Orta Emisyon">Orta Emisyon (50-200kg)</option><option value="Yüksek Emisyon">Yüksek Emisyon (>200kg)</option></select></div>
                    <div class="col-md-4"><button class="btn btn-secondary" onclick="window.resetFilter()">🔄 Filtreyi Sıfırla</button></div>
                </div>
                <div id="orderHistory"><div class="text-center text-muted"><p>🔍 Henüz hesaplanmış sipariş yok.</p><p>İlk siparişinizi eklemek için formu doldurun!</p></div></div>
            </div>
        </div>

        <footer>
            <p>© 2025 Sürdürülebilir Üretim Çözümleri | Rabateks</p>
            <p>🌱 Dünya için daha yeşil bir gelecek</p>
        </footer>
    </div>

    <!-- Custom Alert Modal -->
    <div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customAlertModalLabel">Mesaj</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="customAlertModalBody">
                    <!-- Message content will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle (Popper.js ile birlikte) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // Firebase modüllerini import et
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ve global değişkenlerin tanımlandığından emin ol
        // Bu kısım, HTML'in üst kısmındaki <script type="module"> bloğunda tanımlanan global değişkenlere erişimi sağlar.
        const app = window.firebaseApp;
        const db = window.db;
        const auth = window.auth;
        const appId = window.appId;
        // userId'yi window objesinden alıyoruz
        let userId = window.userId; 

        // Grafik örneği ve sipariş geçmişi için global değişkenler
        window.chartInstance = null; // Global yapıldı
        window.orders = []; // Global yapıldı ve Firestore'dan yüklenecek
        // currentEmissionData artık İşlemler için de bir yer içeriyor (7 elemanlı)
        window.currentEmissionData = [0, 0, 0, 0, 0, 0, 0]; // Global yapıldı
        window.currentTotalEmission = 0; // Global yapıldı

        // Emisyon faktörleri ve sektör ortalamaları
        const emissionFactors = {
            electricity: 0.82, // kg CO2e/kWh
            water: 0.001,      // kg CO2e/litre
            steam: 0.184,      // kg CO2e/kg
            gas: 2.016,        // kg CO2e/m³
            transport: 0.21,   // kg CO2e/km (ortalama taşıma)
            materials: {
                // Her malzeme için baz emisyon (kg CO2e/kg malzeme) ve menşe modifikatörleri
                PES: { base: 9.52, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                rPES: { base: 4.2, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                PA: { base: 9.6, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                CO: { base: 5.9, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                rCO: { base: 2.1, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                WO: { base: 10.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                PAN: { base: 8.5, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                PP: { base: 3.4, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                LI: { base: 2.1, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                SE: { base: 11.5, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                VI: { base: 5.6, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                CUP: { base: 4.2, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                CMD: { base: 4.1, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                CLY: { base: 2.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                EL: { base: 9.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                SP: { base: 9.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                LY: { base: 9.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } }
            },
            tech_modifier: { standard: 1.0, bat: 0.8 }, // BAT teknolojisi %20 daha az emisyon
            // Yeni eklenen işlem bazlı emisyon faktörleri (kg CO2e / birim miktar)
            process_factors: {
                Boyama: 0.5,   // kg CO2e / birim (örn: Kg kumaş)
                Baski: 0.3,    // kg CO2e / birim
                Apre: 0.2,     // kg CO2e / birim
                Dokuma: 0.4,   // kg CO2e / birim
                Orme: 0.35,    // kg CO2e / birim
                Kesim: 0.1,    // kg CO2e / birim
                Dikim: 0.15,   // kg CO2e / birim
                Bitis: 0.05    // kg CO2e / birim
            }
        };
        const sectorAverages = { 'Konfeksiyon': 15.2, 'Kumaş': 8.7, 'İplik': 12.3 }; // kg CO2e/birim

        /**
         * Belirtilen element için hata mesajını gösterir ve input'u geçersiz olarak işaretler.
         * @param {string} elementId - Hata gösterilecek HTML elementinin ID'si.
         * @param {string} message - Gösterilecek hata mesajı.
         */
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            // Eğer element doğrudan bir input/select değilse (örn: processError), doğrudan hata mesajı div'ini bul
            const errEl = document.getElementById(`${elementId}Error`) || document.getElementById(elementId); 
            
            if (el && el.tagName) { // input/select ise
                el.classList.add('is-invalid');
                el.classList.remove('is-valid');
            }
            if (errEl) { // Hata mesajı gösterecek bir div varsa
                errEl.textContent = message; 
                errEl.style.display = 'block'; 
                // Eğer processError gibi bir genel hata div'iyse, ona shake animasyonu ekle
                if (elementId.includes('Error')) {
                    errEl.classList.add('shake-animation'); // CSS'te bu animasyonu tanımlamanız gerekebilir
                    setTimeout(() => errEl.classList.remove('shake-animation'), 500);
                }
            }
        }

        /**
         * Belirtilen element için hata mesajını gizler ve input'un geçersiz işaretini kaldırır.
         * @param {string} elementId - Hata gizlenecek HTML elementinin ID'si.
         */
        function hideError(elementId) {
            const el = document.getElementById(elementId);
            const errEl = document.getElementById(`${elementId}Error`);

            if (el && el.tagName) {
                el.classList.remove('is-invalid');
            }
            if (errEl) {
                errEl.style.display = 'none';
            }
        }

        /**
         * Belirtilen elementin geçerli olduğunu işaretler ve hata mesajını gizler.
         * @param {string} elementId - Geçerli olarak işaretlenecek HTML elementinin ID'si.
         */
        function markAsValid(elementId) {
            const el = document.getElementById(elementId);
            if (el && el.tagName) {
                el.classList.remove('is-invalid');
                el.classList.add('is-valid');
            }
            const errEl = document.getElementById(`${elementId}Error`);
            if (errEl) {
                errEl.style.display = 'none';
            }
        }

        /**
         * Karışım hammaddesi seçildiğinde yeni bir malzeme ve oran giriş alanı ekler.
         */
        function addBlendInput() {
            const blendInputs = document.getElementById('blendInputs');
            const inputGroup = document.createElement('div');
            inputGroup.className = 'blend-input-group';
            inputGroup.innerHTML = `<div class="row"><div class="col-md-6"><select class="form-select" name="blendMaterial"><option value="">Malzeme Seçin</option><option value="PES">PES</option><option value="rPES">rPES</option><option value="PA">PA</option><option value="CO">CO</option><option value="rCO">rCO</option><option value="WO">WO</option><option value="PAN">PAN</option><option value="PP">PP</option><option value="LI">LI</option><option value="SE">SE</option><option value="VI">VI (Viskoz)</option><option value="CUP">CUP (Kupro)</option><option value="CMD">CMD (Modal)</option><option value="CLY">CLY (Lyocell)</option><option value="EL">EL (Elastane)</option><option value="SP">SP (Spandex)</option><option value="LY">LY (Lycra)</option></select></div><div class="col-md-4"><input type="number" class="form-control" name="blendPercentage" min="0" max="100" placeholder="Oran (%)"></div><div class="col-md-2"><button class="btn btn-danger btn-sm" type="button" onclick="this.parentElement.parentElement.parentElement.remove(); window.validateBlendSum();">🗑️ Sil</button></div></div>`;
            blendInputs.appendChild(inputGroup);
            // Yeni eklenen inputlar için de change listener ekleyelim ki sum anlık olarak kontrol edilsin
            const newPercentageInput = inputGroup.querySelector('input[name="blendPercentage"]');
            if (newPercentageInput) {
                newPercentageInput.addEventListener('input', window.validateBlendSum);
            }
            const newMaterialSelect = inputGroup.querySelector('select[name="blendMaterial"]');
            if (newMaterialSelect) {
                newMaterialSelect.addEventListener('change', window.validateBlendSum);
            }
        }

        /**
         * Karışım oranlarının toplamının %100 olup olmadığını ve malzemelerin seçili olup olmadığını kontrol eder.
         * @returns {boolean} - Toplam %100 ve tüm malzemeler seçiliyse true, aksi takdirde false.
         */
        window.validateBlendSum = function() { // Global yapıldı
            const blendPercentages = document.querySelectorAll('input[name="blendPercentage"]');
            let totalPercentage = 0;
            let isValidMaterials = true; // Tüm malzemeler seçili mi?

            blendPercentages.forEach(input => {
                const percentage = parseFloat(input.value);
                if (isNaN(percentage) || percentage < 0 || percentage > 100) {
                    isValidMaterials = false;
                    // showError(input.id, "Oran 0-100 arasında olmalı"); // Her input için ayrı ayrı hata gösterilebilir
                }
                totalPercentage += percentage;
            });

            const blendMaterials = document.querySelectorAll('select[name="blendMaterial"]');
            blendMaterials.forEach(select => {
                if (select.value === '') {
                    isValidMaterials = false;
                    // showError(select.id, "Lütfen malzeme seçin"); // Her select için ayrı ayrı hata gösterilebilir
                }
            });

            // Eğer hiç karışım input'u yoksa ve "Karışım" seçiliyse hata ver
            if (blendPercentages.length === 0 && document.getElementById('material').value === 'Karışım') {
                showError('blendError', 'Karışım hammaddesi için en az bir malzeme eklemeli ve oranını girmelisiniz.');
                return false;
            }
            // Eğer karışım input'ları varsa ama toplam %100 değilse veya malzemeler seçili değilse hata ver
            else if (blendPercentages.length > 0 && (totalPercentage !== 100 || !isValidMaterials)) {
                if (totalPercentage !== 100) {
                    showError('blendError', `Toplam oran %100 olmalıdır! Şu an: ${totalPercentage}%`);
                } else if (!isValidMaterials) {
                    showError('blendError', 'Lütfen tüm karışım malzemelerini seçin.');
                }
                return false;
            }
            // Her şey yolundaysa hatayı gizle
            hideError('blendError');
            // Karışım alanı geçerli olduğunda, tüm ilgili inputları valid olarak işaretle
            document.querySelectorAll('.blend-input-group .form-control, .blend-input-group .form-select').forEach(el => markAsValid(el.id || el.name));
            return true;
        }

        /**
         * Formu sıfırlar ve tüm sonuç alanlarını başlangıç durumuna getirir.
         */
        function resetForm() {
            document.getElementById('carbonForm').reset();
            document.getElementById('blendSection').style.display = 'none';
            document.getElementById('blendInputs').innerHTML = '';
            document.querySelectorAll('.error').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.form-control, .form-select, .form-check-input').forEach(el => el.classList.remove('is-invalid', 'is-valid'));
            
            // Checkbox'ların checked durumunu sıfırla
            document.querySelectorAll('#carbonForm input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            document.getElementById('totalEmission').textContent = '0.00 kg';
            document.getElementById('treeEquivalent').textContent = 'Bu miktar, 0 ağacın bir yılda temizleyebileceği CO₂ miktarına eşdeğerdir.';
            document.getElementById('taxonomyCompliance').textContent = 'Hesaplanıyor...';
            document.getElementById('taxonomyCompliance').className = 'compliance-badge';
            document.getElementById('recycleScore').textContent = '0/100';
            document.getElementById('suggestions').textContent = '-';
            document.getElementById('sustainabilityScore').textContent = '0/100';
            document.getElementById('sustainabilityBar').style.width = '0%';
            document.getElementById('unitEmission').textContent = '0.00 kg/birim';
            document.getElementById('sectorAverage').textContent = '-';
            document.getElementById('performanceRating').textContent = '-';
            document.getElementById('performanceRating').className = 'compliance-badge';
            document.getElementById('simulationResult').style.display = 'none';
            // İşlem emisyonu için de sıfırlama ekle
            ['electricity', 'water', 'steam', 'gas', 'transport', 'material', 'process'].forEach(type => { document.getElementById(`${type}Emission`).textContent = '0.00'; });
            window.currentEmissionData = [0, 0, 0, 0, 0, 0, 0]; // Global değişken
            window.currentTotalEmission = 0; // Global değişken
            window.updateChart(); // Global fonksiyonu çağır
        }

        /**
         * Emisyon dağılım grafiğini günceller.
         */
        window.updateChart = function() { // Global yapıldı
            const chartType = document.getElementById('chartType').value;
            const ctx = document.getElementById('emissionChart').getContext('2d');
            if (window.chartInstance) { window.chartInstance.destroy(); } // Mevcut grafik örneğini yok et
            const config = {
                type: chartType,
                data: {
                    // Etiketlere "İşlemler" eklendi
                    labels: ['Elektrik', 'Su', 'Buhar', 'Doğalgaz', 'Taşıma', 'Hammadde', 'İşlemler'], 
                    datasets: [{ 
                        label: 'CO₂ Emisyonu (kg)', 
                        data: window.currentEmissionData, // Global değişken
                        // Yeni kategori için renk eklendi
                        backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#A0D9B1'], 
                        borderWidth: 2, 
                        tension: 0.4 
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'top' }, 
                        title: { display: true, text: 'CO₂ Emisyon Dağılımı' } 
                    },
                    scales: chartType !== 'pie' && chartType !== 'doughnut' ? { y: { beginAtZero: true, ticks: { callback: value => value + ' kg' } } } : {}
                }
            };
            window.chartInstance = new Chart(ctx, config); // Global değişken
        }

        /**
         * Form gönderildiğinde emisyonları hesaplar, sonuçları gösterir ve sipariş geçmişine kaydeder.
         */
        document.getElementById('carbonForm').addEventListener('submit', async function(e) { // async olarak işaretle
            e.preventDefault(); // Formun varsayılan gönderimini engelle
            document.getElementById('loading').style.display = 'block'; // Yükleme animasyonunu göster
            let isValid = true; // Formun geçerli olup olmadığını tutan bayrak

            // Tüm hata mesajlarını ve validasyon işaretlerini sıfırla
            document.querySelectorAll('.error').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.form-control, .form-select').forEach(el => el.classList.remove('is-invalid', 'is-valid'));

            // Temel alanların validasyonu
            const fields = [
                { id: 'orderId', msg: 'Sipariş ID boş olamaz.', check: val => val.trim() !== '' },
                { id: 'productType', msg: 'Lütfen bir ürün tipi seçin.', check: val => val !== '' },
                { id: 'material', msg: 'Lütfen bir hammadde seçin.', check: val => val !== '' },
                { id: 'unit', msg: 'Lütfen bir birim seçin.', check: val => val !== '' },
                { id: 'quantity', msg: 'Miktar pozitif bir sayı olmalıdır.', check: val => parseFloat(val) > 0 }
            ];

            fields.forEach(f => {
                const el = document.getElementById(f.id);
                if (!el || !f.check(el.value)) {
                    showError(f.id, f.msg);
                    isValid = false;
                } else {
                    markAsValid(f.id);
                }
            });

            // Sayısal Girişler İçin Ek Kontroller (Sıfır veya Pozitif ve Geri Dönüştürülmüş İçerik Aralığı)
            const numericFields = [
                { id: 'electricity', msg: 'Elektrik tüketimi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'water', msg: 'Su tüketimi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'steam', msg: 'Buhar tüketimi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'gas', msg: 'Doğalgaz tüketimi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'transport', msg: 'Taşıma mesafesi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'recycledContent', msg: 'Geri dönüştürülmüş içerik 0 ile 100 arasında olmalıdır.', check: val => parseFloat(val) >= 0 && parseFloat(val) <= 100 }
            ];

            numericFields.forEach(f => {
                const el = document.getElementById(f.id);
                // Eğer alan boşsa ve zorunlu değilse (varsayılan 0 olarak kabul edeceğiz), valid kabul et
                if (el && el.value.trim() === '') {
                    markAsValid(f.id);
                } else if (el && !f.check(el.value)) { // Sadece el mevcutsa ve geçersizse hata göster
                    showError(f.id, f.msg);
                    isValid = false;
                } else if (el) { // Eğer el mevcutsa ve geçerliyse markAsValid yap
                    markAsValid(f.id);
                }
            });

            // Kumaş Tipi Validasyonu
            const productType = document.getElementById('productType').value;
            const fabricType = document.getElementById('fabricType').value;
            if ((productType === 'Konfeksiyon' || productType === 'Kumaş') && fabricType === '') {
                showError('fabricType', 'Konfeksiyon veya kumaş ürünleri için kumaş tipi seçmelisiniz.');
                isValid = false;
            } else {
                hideError('fabricType'); 
                if(fabricType !== '') { // Eğer seçili ve zorunluluk durumu karşılanıyorsa markAsValid
                    markAsValid('fabricType');
                } else {
                     // Eğer kumaş tipi seçilmesi zorunlu değilse ve boşsa, is-valid durumunu kaldır
                    document.getElementById('fabricType').classList.remove('is-valid');
                }
            }

            // İşlem Türü Validasyonu
            const processCheckboxes = document.querySelectorAll('#carbonForm input[type="checkbox"][id^="process"]');
            const isAnyProcessSelected = Array.from(processCheckboxes).some(checkbox => checkbox.checked);
            if (!isAnyProcessSelected) {
                showError('processError', 'Lütfen en az bir işlem türü seçin.'); // Hata mesajını direkt error div'ine yaz
                isValid = false;
            } else {
                hideError('processError');
            }

            // Karışım Oranları Validasyonu
            const material = document.getElementById('material').value;
            if (material === 'Karışım') {
                if (!window.validateBlendSum()) { // Global fonksiyonu çağır
                    isValid = false;
                }
            }

            // Eğer form geçerli değilse, hesaplamayı durdur
            if (!isValid) {
                document.getElementById('loading').style.display = 'none';
                return;
            }
            
            try {
                // Formdan değerleri al
                const electricity = parseFloat(document.getElementById('electricity').value) || 0;
                const water = parseFloat(document.getElementById('water').value) || 0;
                const steam = parseFloat(document.getElementById('steam').value) || 0;
                const gas = parseFloat(document.getElementById('gas').value) || 0;
                const transport = parseFloat(document.getElementById('transport').value) || 0;
                const recycledContent = parseFloat(document.getElementById('recycledContent').value) || 0;
                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                const materialOrigin = document.getElementById('materialOrigin').value;
                const productionTech = document.getElementById('productionTech').value;

                // Emisyonları hesapla
                const electricityEmission = electricity * emissionFactors.electricity;
                const waterEmission = water * emissionFactors.water;
                const steamEmission = steam * emissionFactors.steam;
                const gasEmission = gas * emissionFactors.gas;
                const transportEmission = transport * emissionFactors.transport;
                
                let materialEmission = 0;
                if (material !== 'Karışım' && emissionFactors.materials[material]) {
                    const matData = emissionFactors.materials[material];
                    materialEmission = (matData.base * (matData.origin_modifier[materialOrigin] || 1.0)) * quantity;
                } else if (material === 'Karışım') {
                    // Karışım hammaddesi hesaplaması
                    const blendInputs = document.querySelectorAll('#blendInputs .blend-input-group');
                    let blendedMaterialEmissionPerUnit = 0; // Birim başına karışım emisyonu
                    blendInputs.forEach(group => {
                        const blendMat = group.querySelector('select[name="blendMaterial"]').value;
                        const blendPct = parseFloat(group.querySelector('input[name="blendPercentage"]').value) || 0;

                        if (blendMat && emissionFactors.materials[blendMat]) {
                            const matData = emissionFactors.materials[blendMat];
                            // Her bir karışım malzemesinin oranına göre emisyonunu topla
                            blendedMaterialEmissionPerUnit += (matData.base * (matData.origin_modifier[materialOrigin] || 1.0)) * (blendPct / 100);
                        }
                    });
                    materialEmission = blendedMaterialEmissionPerUnit * quantity; // Toplam miktar ile çarp
                }

                // İşlem bazlı emisyonları hesapla
                let processEmission = 0;
                const processCheckboxes = document.querySelectorAll('#carbonForm input[type="checkbox"][id^="process"]');
                processCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        // ID'den işlem adını al (örn: "Boyama" from "processBoyama")
                        const processKey = checkbox.id.replace('process', ''); 
                        if (emissionFactors.process_factors[processKey]) {
                            processEmission += emissionFactors.process_factors[processKey] * quantity; // Miktar ile çarp
                        }
                    }
                });


                const rawTotal = electricityEmission + waterEmission + steamEmission + gasEmission + transportEmission + materialEmission + processEmission; // İşlem emisyonu da eklendi
                const techModifier = emissionFactors.tech_modifier[productionTech] || 1.0;
                
                let sustainabilityBonus = 0;
                if (document.getElementById('sustainableWaterless').checked) sustainabilityBonus += 0.05; // %5 azaltma (örnek)
                if (document.getElementById('sustainableDigital').checked) sustainabilityBonus += 0.05; // %5 azaltma (örnek)
                if (document.getElementById('sustainableRenewable').checked) sustainabilityBonus += 0.10; // %10 azaltma (örnek)


                const recyclingBonus = (recycledContent / 100) * 0.30; // Geri dönüştürülmüş içeriğin emisyonu %30'a kadar azalttığını varsayalım

                // Toplam emisyon hesaplaması: (Ham Toplam * Teknoloji Modifiye) * (1 - Sürdürülebilirlik Bonusları - Geri Dönüşüm Bonusu)
                // Math.max(0, ...) ile emisyonun negatif olmasını engelle
                const totalEmission = rawTotal * techModifier * Math.max(0, (1 - sustainabilityBonus - recyclingBonus));
                window.currentTotalEmission = totalEmission; // Global değişken

                // Emisyonları güncelle (grafik için)
                window.currentEmissionData = [ // Global değişken
                    electricityEmission.toFixed(2),
                    waterEmission.toFixed(2),
                    steamEmission.toFixed(2),
                    gasEmission.toFixed(2),
                    transportEmission.toFixed(2),
                    materialEmission.toFixed(2),
                    processEmission.toFixed(2) // Yeni: İşlem emisyonu
                ];

                // Sonuçları UI'a yaz
                document.getElementById('electricityEmission').textContent = electricityEmission.toFixed(2);
                document.getElementById('waterEmission').textContent = waterEmission.toFixed(2);
                document.getElementById('steamEmission').textContent = steamEmission.toFixed(2);
                document.getElementById('gasEmission').textContent = gasEmission.toFixed(2);
                document.getElementById('transportEmission').textContent = transportEmission.toFixed(2);
                document.getElementById('materialEmission').textContent = materialEmission.toFixed(2);
                document.getElementById('processEmission').textContent = processEmission.toFixed(2); // Yeni: İşlem emisyonu
                document.getElementById('totalEmission').textContent = `${totalEmission.toFixed(2)} kg`;
                
                const treesEquivalent = (totalEmission / 21.77).toFixed(2); // Bir ağacın yılda ortalama 21.77 kg CO2 emdiği varsayımıyla
                document.getElementById('treeEquivalent').textContent = `Bu miktar, ${treesEquivalent} ağacın bir yılda temizleyebileceği CO₂ miktarına eşdeğerdir.`;

                // Sürdürülebilirlik Skoru Hesaplaması
                const unitEmission = (quantity > 0 ? totalEmission / quantity : 0);
                const baseScore = 100;
                let scoreDeduction = unitEmission * 5; // Birim başına emisyon arttıkça puan düşsün
                if (isNaN(scoreDeduction) || !isFinite(scoreDeduction)) scoreDeduction = 0; // Infinity/NaN kontrolü
                
                let calculatedSustainabilityScore = baseScore - scoreDeduction + (recycledContent * 0.5); // Geri dönüşüm de puanı artırsın
                if (document.getElementById('sustainableRenewable').checked) calculatedSustainabilityScore += 10;
                if (document.getElementById('sustainableWaterless').checked) calculatedSustainabilityScore += 5;
                if (document.getElementById('sustainableDigital').checked) calculatedSustainabilityScore += 3;

                calculatedSustainabilityScore = Math.max(0, Math.min(100, calculatedSustainabilityScore)); // 0-100 arasında tut

                document.getElementById('sustainabilityScore').textContent = `${calculatedSustainabilityScore.toFixed(0)}/100`;
                document.getElementById('sustainabilityBar').style.width = `${calculatedSustainabilityScore}%`;

                // AB Uyumluluğu ve Öneriler
                let taxonomyCompliance = 'Uyumsuz';
                let complianceClass = 'compliance-error';
                let suggestions = [];

                if (recycledContent >= 50 && unitEmission < (sectorAverages[productType] || 10) * 0.8) { // Sektör ortalamasının %80'inden az ise ve geri dönüşüm %50 üzeri ise uyumlu say
                    taxonomyCompliance = 'Uyumlu';
                    complianceClass = 'compliance-good';
                } else if (recycledContent >= 30 || unitEmission < (sectorAverages[productType] || 10)) { // Hafif uyumlu
                    taxonomyCompliance = 'Kısmen Uyumlu';
                    complianceClass = 'compliance-warning';
                }

                if (recycledContent < 50) {
                    suggestions.push(`Geri dönüştürülmüş içerik oranını artırarak AB 2030 hedefine (%50) ulaşın.`);
                }
                if (unitEmission >= (sectorAverages[productType] || 10) * 0.8) {
                    suggestions.push(`Birim başına emisyonu azaltmak için üretim verimliliğini artırın veya sürdürülebilir teknolojilere yatırım yapın.`);
                }
                if (!document.getElementById('sustainableRenewable').checked) {
                    suggestions.push(`Yenilenebilir enerji kaynaklarına geçiş yapmayı düşünün.`);
                }
                if (!document.getElementById('sustainableWaterless').checked && document.getElementById('processBoyama').checked) {
                    suggestions.push(`Su kullanmayan boyama tekniklerini araştırın.`);
                }

                document.getElementById('taxonomyCompliance').textContent = taxonomyCompliance;
                document.getElementById('taxonomyCompliance').className = `compliance-badge ${complianceClass}`;
                document.getElementById('recycleScore').textContent = `${recycledContent.toFixed(0)}/100`;
                document.getElementById('suggestions').textContent = suggestions.length > 0 ? suggestions.join(' ') : 'Tebrikler, iyi bir performans sergiliyorsunuz!';

                // Detaylı Analiz
                document.getElementById('unitEmission').textContent = `${unitEmission.toFixed(2)} kg/${document.getElementById('unit').value}`;
                document.getElementById('sectorAverage').textContent = `${(sectorAverages[productType] || 0).toFixed(2)} kg/birim (sektör ortalaması)`;
                
                let performanceRating = '';
                let performanceClass = '';
                const average = sectorAverages[productType] || 0;

                if (unitEmission < average * 0.8) {
                    performanceRating = 'Mükemmel';
                    performanceClass = 'compliance-good';
                } else if (unitEmission < average * 1.1) {
                    performanceRating = 'İyi';
                    performanceClass = 'compliance-warning';
                } else {
                    performanceRating = 'Geliştirilmeli';
                    performanceClass = 'compliance-error';
                }
                document.getElementById('performanceRating').textContent = performanceRating;
                document.getElementById('performanceRating').className = `compliance-badge ${performanceClass}`;

                // Güncel emisyon verilerini Chart.js için hazırla
                window.currentEmissionData = [ // Global değişken
                    electricityEmission.toFixed(2),
                    waterEmission.toFixed(2),
                    steamEmission.toFixed(2),
                    gasEmission.toFixed(2),
                    transportEmission.toFixed(2),
                    materialEmission.toFixed(2),
                    processEmission.toFixed(2) // Yeni: İşlem emisyonu
                ];
                window.updateChart(); // Global fonksiyonu çağır

                // Sipariş objesini oluştur ve kaydet
                const order = {
                    id: document.getElementById('orderId').value, 
                    productType: document.getElementById('productType').value,
                    fabricType: document.getElementById('fabricType').value,
                    material: material, 
                    materialOrigin: materialOrigin,
                    productionTech: productionTech,
                    quantity: quantity, 
                    unit: document.getElementById('unit').value,
                    electricity: electricity,
                    water: water,
                    steam: steam,
                    gas: gas,
                    transport: transport,
                    recycledContent: recycledContent,
                    processes: Array.from(processCheckboxes).filter(cb => cb.checked).map(cb => cb.labels[0].textContent), // İşlem türlerinin metinlerini al
                    sustainableProcesses: [
                        document.getElementById('sustainableWaterless').checked ? 'Su Kullanmayan Boyama' : '',
                        document.getElementById('sustainableDigital').checked ? 'Dijital Baskı' : '',
                        document.getElementById('sustainableRenewable').checked ? 'Yenilenebilir Enerji' : ''
                    ].filter(Boolean), // Sadece seçili olanları al
                    emission: totalEmission, 
                    unitEmission: unitEmission,
                    sustainabilityScore: calculatedSustainabilityScore,
                    recycleScore: recycledContent,
                    taxonomyCompliance: taxonomyCompliance,
                    // timestamp: new Date().toLocaleString('tr-TR'), // Firestore'dan serverTimestamp kullanacağız
                    emissionBreakdown: { // Detaylı kırılımı da saklayalım
                        electricity: electricityEmission,
                        water: waterEmission,
                        steam: steamEmission,
                        gas: gasEmission,
                        transport: transportEmission,
                        material: materialEmission,
                        processes: processEmission // Yeni: İşlem emisyonu
                    }
                };
                // Siparişi Firestore'a kaydet
                await window.saveOrderToFirestore(order);

            } catch (err) {
                console.error("Hesaplama veya kaydetme hatası:", err);
                window.showMessage("Hata", "Hesaplama veya kaydetme sırasında bir hata oluştu. Lütfen tüm alanları doğru girdiğinizden emin olun. Hata: " + err.message, "error");
            } finally {
                document.getElementById('loading').style.display = 'none'; // Yükleme animasyonunu gizle
            }
        });

        /**
         * Kaydedilmiş siparişleri görüntüler ve filtreleme yapar.
         * @param {string} filter - Filtreleme kriteri (ürün tipi veya emisyon aralığı).
         */
        window.displayOrders = function(filter = '') { // Global yapıldı
            const container = document.getElementById('orderHistory');
            if (!window.orders || window.orders.length === 0) { // Global değişken
                container.innerHTML = `<div class="text-center text-muted"><p>🔍 Henüz hesaplanmış sipariş yok.</p><p>İlk siparişinizi eklemek için formu doldurun!</p></div>`; 
                return; 
            }
            let toDisplay = window.orders; // Global değişken

            if (filter) {
                if (filter === 'Düşük Emisyon') {
                    toDisplay = window.orders.filter(o => o.emission < 50);
                } else if (filter === 'Orta Emisyon') {
                    toDisplay = window.orders.filter(o => o.emission >= 50 && o.emission <= 200);
                } else if (filter === 'Yüksek Emisyon') {
                    toDisplay = window.orders.filter(o => o.emission > 200);
                } else {
                    toDisplay = window.orders.filter(o => o.productType === filter);
                }
            }

            // Siparişleri en yeniye göre sırala (Firestore'dan gelen timestamp'e göre)
            toDisplay.sort((a, b) => {
                // Firestore'dan gelen timestamp objesi varsa, onu kullan
                const dateA = a.timestamp instanceof Date ? a.timestamp.getTime() : new Date(a.timestamp).getTime();
                const dateB = b.timestamp instanceof Date ? b.timestamp.getTime() : new Date(b.timestamp).getTime();
                return dateB - dateA;
            });


            container.innerHTML = toDisplay.map(o => `
                <div class="order-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Sipariş ID:</strong> ${o.id}<br>
                            <strong>Ürün Tipi:</strong> ${o.productType} ${o.fabricType ? `(${o.fabricType})` : ''}<br>
                            <strong>Hammadde:</strong> ${o.material} (${o.materialOrigin})<br>
                            <strong>Miktar:</strong> ${o.quantity} ${o.unit}<br>
                            <strong>Toplam Emisyon:</strong> <span class="text-danger fw-bold">${o.emission.toFixed(2)} kg CO₂</span>
                        </div>
                        <div>
                            <span class="compliance-badge ${o.taxonomyCompliance === 'Uyumlu' ? 'compliance-good' : (o.taxonomyCompliance === 'Kısmen Uyumlu' ? 'compliance-warning' : 'compliance-error')}">${o.taxonomyCompliance}</span><br>
                            <small class="text-muted">${o.timestamp}</small>
                        </div>
                    </div>
                </div>
            `).join('');

            if (toDisplay.length === 0) {
                container.innerHTML = `<div class="text-center text-muted"><p>Seçilen filtreye uygun sipariş bulunamadı.</p></div>`;
            }
        }
        
        /**
         * Son hesaplanan siparişin detaylı raporunu TXT olarak dışa aktarır.
         */
        window.exportReport = function() { // Global yapıldı
            if (!window.orders || window.orders.length === 0) { window.showMessage("Bilgi", "Dışa aktarılacak sipariş bulunamadı!", "info"); return; } // Global değişken
            const lastOrder = window.orders[window.orders.length - 1]; // Global değişken
            const reportText = `CO₂ TrackIt Raporu\n\n` +
                               `Sipariş ID: ${lastOrder.id}\n` +
                               `Ürün Tipi: ${lastOrder.productType}\n` +
                               `Kumaş Tipi: ${lastOrder.fabricType || 'Belirtilmedi'}\n` +
                               `Hammadde: ${lastOrder.material} (${lastOrder.materialOrigin})\n` +
                               `Miktar: ${lastOrder.quantity} ${lastOrder.unit}\n` +
                               `Geri Dönüştürülmüş İçerik: %${lastOrder.recycledContent}\n` +
                               `Üretim Teknolojisi: ${lastOrder.productionTech === 'bat' ? 'Mümkün Olan En İyi Teknoloji (BAT)' : 'Standart Teknoloji'}\n` +
                               `Uygulanan İşlemler: ${lastOrder.processes.join(', ') || 'Belirtilmedi'}\n` +
                               `Sürdürülebilir İşlemler: ${lastOrder.sustainableProcesses.join(', ') || 'Yok'}\n\n` +
                               `--- Emisyon Detayları ---\n` +
                               `Toplam CO₂ Emisyonu: ${lastOrder.emission.toFixed(2)} kg\n` +
                               `Birim Başına Emisyon: ${lastOrder.unitEmission.toFixed(2)} kg/${lastOrder.unit}\n` +
                               `Elektrik Emisyonu: ${lastOrder.emissionBreakdown.electricity.toFixed(2)} kg\n` +
                               `Su Emisyonu: ${lastOrder.emissionBreakdown.water.toFixed(2)} kg\n` +
                               `Buhar Emisyonu: ${lastOrder.emissionBreakdown.steam.toFixed(2)} kg\n` +
                               `Doğalgaz Emisyonu: ${lastOrder.emissionBreakdown.gas.toFixed(2)} kg\n` +
                               `Taşıma Emisyonu: ${lastOrder.emissionBreakdown.transport.toFixed(2)} kg\n` +
                               `Hammadde Emisyonu: ${lastOrder.emissionBreakdown.material.toFixed(2)} kg\n` +
                               `İşlem Emisyonu: ${lastOrder.emissionBreakdown.processes.toFixed(2)} kg\n\n` + // Yeni: İşlem emisyonu
                               `--- Sürdürülebilirlik Değerlendirmesi ---\n` +
                               `Sürdürülebilirlik Skoru: ${lastOrder.sustainabilityScore.toFixed(0)}/100\n` +
                               `Geri Dönüşüm Skoru: ${lastOrder.recycleScore.toFixed(0)}/100\n` +
                               `AB Taxonomy Uyumu: ${lastOrder.taxonomyCompliance}\n` +
                               `Tarih: ${lastOrder.timestamp}\n\n` +
                               `Rabateks CO₂ TrackIt tarafından oluşturulmuştur.`;
            const blob = new Blob([reportText], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `CO2_Rapor_${lastOrder.id}.txt`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        /**
         * Son hesaplanan sipariş için AB uyumluluk kontrolünü gösterir.
         */
        window.checkCompliance = function() { // Global yapıldı
            if (!window.orders || window.orders.length === 0) { window.showMessage("Bilgi", "Kontrol edilecek sipariş bulunamadı!", "info"); return; } // Global değişken
            const lastOrder = window.orders[window.orders.length - 1]; // Global değişken
            const messages = [`Sipariş ID: ${lastOrder.id} için Uyumluluk Kontrolü:\n`];
            messages.push(`- AB Yeşil Mutabakatı Uyumu: ${lastOrder.taxonomyCompliance}`);
            messages.push(`- Geri Dönüşüm Skoru: ${lastOrder.recycleScore.toFixed(0)}/100 (Hedef: %50 üzeri)`);
            messages.push(`- Birim Başına Emisyon: ${lastOrder.unitEmission.toFixed(2)} kg/${lastOrder.unit} (Sektör Ortalaması: ${(sectorAverages[lastOrder.productType] || 0).toFixed(2)} kg/${lastOrder.unit})`);
            messages.push(`\nÖneriler:\n${document.getElementById('suggestions').textContent}`);
            window.showMessage("AB Uyumluluk Kontrolü", messages.join('\n'), "info");
        }

        /**
         * Son hesaplanan sipariş için AB Raporu oluşturur ve gösterir.
         */
        window.generateEUReport = function() { // Global yapıldı
            if (!window.orders || window.orders.length === 0) { window.showMessage("Bilgi", "Rapor oluşturulacak sipariş bulunamadı!", "info"); return; } // Global değişken
            const lastOrder = window.orders[window.orders.length - 1]; // Global değişken
            const euReport = `🇪🇺 AVRUPA BİRLİĞİ YEŞİL MUTABAKAT RAPORU\n\n` +
                             `Bu rapor, Rabateks tarafından sunulan CO₂ TrackIt aracı kullanılarak AB Yeşil Mutabakatı kriterleri doğrultusunda hazırlanmıştır.\n\n` +
                             `Ürün Dijital Pasaportu (DPP) Bilgileri:\n` +
                             `  - Sipariş ID: ${lastOrder.id}\n` +
                             `  - Ürün Tipi: ${lastOrder.productType}\n` +
                             `  - Hammadde: ${lastOrder.material}\n` +
                             `  - Geri Dönüştürülmüş İçerik: %${lastOrder.recycledContent}\n` +
                             `  - Toplam CO₂ Emisyonu: ${lastOrder.emission.toFixed(2)} kg\n` +
                             `  - Birim Başına CO₂: ${lastOrder.unitEmission.toFixed(2)} kg/${lastOrder.unit}\n` +
                             `  - EU Taxonomy Uyum Durumu: ${lastOrder.taxonomyCompliance}\n` +
                             `  - Sürdürülebilirlik Skoru: ${lastOrder.sustainabilityScore.toFixed(0)}/100\n` +
                             `\nDetaylı Emisyon Kırılımları ve Sürdürülebilirlik Uygulamaları bu ürün için kaydedilmiştir.\n` +
                             `Tarih: ${lastOrder.timestamp}\n\n` +
                             `Daha fazla bilgi için: rabateks.com`;
            window.showMessage("AB Raporu", euReport, "info");
        }

        /**
         * Kullanıcının seçtiği simülasyon türüne göre emisyonu simüle eder ve sonucu gösterir.
         */
        window.runSimulation = function() { // Global yapıldı
            if (window.currentTotalEmission <= 0) { window.showMessage("Bilgi", 'Lütfen önce bir hesaplama yapın.', "info"); return; } // Global değişken
            const type = document.getElementById('simulationType').value;
            let value = parseFloat(document.getElementById('simulationValue').value);
            const resultDiv = document.getElementById('simulationResult');
            let simulatedEmission = window.currentTotalEmission; // Global değişken
            let simulationText = '';

            if (type === 'recycle') {
                if (isNaN(value) || value < 0 || value > 100) {
                    window.showMessage("Hata", 'Geri dönüşüm oranı için 0-100 arasında bir değer girin.', "error");
                    return;
                }
                const currentRecycledContent = parseFloat(document.getElementById('recycledContent').value) || 0;
                // Mevcut emisyonu, mevcut geri dönüşüm bonusunu çıkararak sıfırla
                // Bu, bonusun nasıl uygulandığına bağlı olarak değişebilir. Basit bir geri alma işlemi.
                let rawEmissionWithoutRecycleBonus = window.currentTotalEmission / (1 - (currentRecycledContent / 100) * 0.30); // Global değişken
                if (isNaN(rawEmissionWithoutRecycleBonus) || !isFinite(rawEmissionWithoutRecycleBonus)) {
                    rawEmissionWithoutRecycleBonus = window.currentTotalEmission; // Hata durumunda değişiklik yapma // Global değişken
                }

                // Yeni geri dönüşüm oranıyla yeniden hesapla
                simulatedEmission = rawEmissionWithoutRecycleBonus * (1 - (value / 100) * 0.30);
                simulationText = `Geri Dönüştürülmüş İçerik Oranı %${value} olsaydı:<br>` +
                                 `Tahmini Yeni CO₂ Emisyonu: <span class="text-success fw-bold">${simulatedEmission.toFixed(2)} kg</span><br>` +
                                 `%${((window.currentTotalEmission - simulatedEmission) / window.currentTotalEmission * 100).toFixed(2)} azalma.`; // Global değişken

            } else if (type === 'energy') {
                // Yenilenebilir enerjiye geçiş, elektrik emisyonunu önemli ölçüde azaltır.
                // Mevcut elektrik emisyonunu bul ve bunu düşürerek simüle et.
                const electricityInput = parseFloat(document.getElementById('electricity').value) || 0;
                const originalElectricityEmission = electricityInput * emissionFactors.electricity;
                
                // Elektrik emisyonu dışındaki diğer emisyonları hesapla
                const nonElectricityEmission = window.currentTotalEmission - originalElectricityEmission; // Global değişken
                
                // Yenilenebilir enerji ile elektrik emisyonunu %90 azalttığımızı varsayalım
                const newElectricityEmission = originalElectricityEmission * 0.10; // %90 azalma
                
                simulatedEmission = nonElectricityEmission + newElectricityEmission;
                simulationText = `Yenilenebilir Enerjiye tamamen geçiş yapılsaydı:<br>` +
                                 `Tahmini Yeni CO₂ Emisyonu: <span class="text-success fw-bold">${simulatedEmission.toFixed(2)} kg</span><br>` +
                                 `%${((window.currentTotalEmission - simulatedEmission) / window.currentTotalEmission * 100).toFixed(2)} azalma.`; // Global değişken
            } else {
                window.showMessage("Bilgi", 'Lütfen bir simülasyon türü seçin.', "info");
                return;
            }

            resultDiv.innerHTML = `<h5>Simülasyon Sonucu:</h5><p>${simulationText}</p>`;
            resultDiv.style.display = 'block';
        }

        /**
         * Son hesaplanan sipariş için Dijital Ürün Pasaportu (DPP) verisini JSON formatında oluşturur ve yeni pencerede gösterir.
         */
        window.generateDPP = function() { // Global yapıldı
            if (!window.orders || window.orders.length === 0) { window.showMessage("Bilgi", 'Pasaport oluşturmak için önce bir sipariş hesaplamalısınız.', "info"); return; } // Global değişken
            const lastOrder = window.orders[window.orders.length - 1]; // Global değişken
            
            // Seçili işlem türlerini ve sürdürülebilir işlemleri al
            const processesSelected = Array.from(document.querySelectorAll('#carbonForm input[type="checkbox"][id^="process"]:checked'))
                                       .map(cb => cb.labels[0].textContent);

            const sustainableProcessesSelected = Array.from(document.querySelectorAll('#carbonForm input[type="checkbox"][id^="sustainable"]:checked'))
                                                    .map(cb => cb.labels[0].textContent);

            const dpp = {
                dpp_id: `urn:uuid:${crypto.randomUUID()}`, // Benzersiz bir ID oluştur
                product_information: {
                    order_id: lastOrder.id,
                    product_type: lastOrder.productType,
                    fabric_type: lastOrder.fabricType || 'N/A', // Kumaş tipi yoksa N/A
                    material: lastOrder.material,
                    quantity: `${lastOrder.quantity} ${lastOrder.unit}`,
                    material_origin: lastOrder.materialOrigin,
                    recycled_content_percentage: `${lastOrder.recycledContent}%`,
                    production_technology: lastOrder.productionTech,
                    processes_involved: processesSelected,
                    sustainable_practices_applied: sustainableProcessesSelected
                },
                environmental_impact: {
                    total_co2_emission_kg: parseFloat(lastOrder.emission.toFixed(2)),
                    co2_per_unit_kg: parseFloat(lastOrder.unitEmission.toFixed(2)),
                    emission_breakdown_kg: lastOrder.emissionBreakdown,
                    sustainability_score_100: parseFloat(lastOrder.sustainabilityScore.toFixed(0)),
                    recycling_score_100: parseFloat(lastOrder.recycleScore.toFixed(0)),
                    eu_taxonomy_compliance: lastOrder.taxonomyCompliance,
                    tree_equivalent: parseFloat((lastOrder.emission / 21.77).toFixed(2))
                },
                producer_information: {
                    name: "Rabateks",
                    website: "https://rabateks.com",
                    contact: "info@rabateks.com"
                },
                timestamp: lastOrder.timestamp,
                // Ek sertifikasyonlar, test raporları vb. buraya eklenebilir
            };
            
            // JSON çıktısını daha okunaklı hale getirmek için yeni bir pencerede gösterelim
            const newWindow = window.open();
            newWindow.document.write('<pre>' + JSON.stringify(dpp, null, 2) + '</pre>');
            newWindow.document.title = `DPP - ${lastOrder.id}`;
            newWindow.document.close();

        }

        /**
         * Sipariş geçmişini filtreler.
         */
        window.filterOrders = function() { window.displayOrders(document.getElementById('orderFilter').value); } // Global yapıldı

        /**
         * Sipariş geçmişi filtresini sıfırlar.
         */
        window.resetFilter = function() { document.getElementById('orderFilter').value = ''; window.displayOrders(); } // Global yapıldı

        /**
         * Bootstrap modalını kullanarak özel bir mesaj gösterir.
         * @param {string} title - Modal başlığı.
         * @param {string} message - Modal içeriği.
         * @param {string} type - Mesaj tipi (örn: 'success', 'error', 'info', 'warning'). Opsiyonel, stil için kullanılabilir.
         */
        window.showMessage = function(title, message, type = 'info') {
            const modalElement = document.getElementById('customAlertModal');
            const modalTitle = document.getElementById('customAlertModalLabel');
            const modalBody = document.getElementById('customAlertModalBody');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = message; // HTML içeriği de kabul edebiliriz

            // Modal başlığına ve/veya gövdesine tip bazlı sınıf ekleyebiliriz (isteğe bağlı)
            modalTitle.className = 'modal-title'; // Önceki sınıfları temizle
            if (type === 'error') {
                modalTitle.classList.add('text-danger');
            } else if (type === 'success') {
                modalTitle.classList.add('text-success');
            } else if (type === 'warning') {
                modalTitle.classList.add('text-warning');
            } else {
                modalTitle.classList.add('text-primary');
            }

            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        };


        // Olay Dinleyicileri
        document.getElementById('material').addEventListener('change', function() {
            document.getElementById('blendSection').style.display = this.value === 'Karışım' ? 'block' : 'none';
            if (this.value !== 'Karışım') {
                hideError('blendError'); // Karışım seçimi değiştiğinde hata mesajını gizle
                document.getElementById('blendInputs').innerHTML = ''; // Karışım inputlarını temizle
            }
        });

        document.getElementById('simulationType').addEventListener('change', function() {
            document.getElementById('simulationValue').style.display = (this.value === 'recycle') ? 'block' : 'none';
            document.getElementById('simulationValue').value = ''; // Seçim değiştiğinde değeri sıfırla
            document.getElementById('simulationResult').style.display = 'none'; // Simülasyon sonucunu gizle
        });

        // DOM yüklendiğinde çalışacak kod
        document.addEventListener('DOMContentLoaded', () => {
            // userId'nin global olarak ayarlanmasını bekleyin
            const checkAuthInterval = setInterval(() => {
                if (window.userId) {
                    clearInterval(checkAuthInterval);
                    window.displayOrders(); // Global fonksiyonu çağır
                    window.updateChart(); // Global fonksiyonu çağır
                }
            }, 100); // Her 100ms'de bir kontrol et

            // Kumaş Tipi alanının zorunluluğunu Product Type seçimine bağlayalım
            document.getElementById('productType').addEventListener('change', function() {
                const productType = this.value;
                const fabricTypeSelect = document.getElementById('fabricType');
                if (productType === 'Konfeksiyon' || productType === 'Kumaş') {
                    // Bu durumda zorunlu ama anlık olarak is-invalid göstermeyelim, submit'te kontrol edelim
                    fabricTypeSelect.required = true;
                    // Eğer kullanıcı daha önce bir seçim yapmadıysa ve hala boşsa, geçerli sayma durumunu kaldır
                    if (fabricTypeSelect.value === '') {
                        fabricTypeSelect.classList.remove('is-valid');
                    }
                } else {
                    fabricTypeSelect.required = false;
                    hideError('fabricType'); // Hata mesajını gizle
                    fabricTypeSelect.classList.remove('is-invalid', 'is-valid'); // Validasyon işaretlerini kaldır
                }
            });
        });
    </script>
</body>
</html>
