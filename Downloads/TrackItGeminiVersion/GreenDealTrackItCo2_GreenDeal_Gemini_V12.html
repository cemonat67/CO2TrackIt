<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>COâ‚‚ TrackIt | Green Deal Uyumlu Karbon HesaplayÄ±cÄ±</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <!-- Firebase SDK Eklentileri -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase yapÄ±landÄ±rmasÄ± ve uygulama kimliÄŸi global deÄŸiÅŸkenlerden alÄ±nÄ±r
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Firebase uygulamasÄ±nÄ± baÅŸlat
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global eriÅŸim iÃ§in deÄŸiÅŸkenleri window objesine ekle
        window.firebaseApp = app;
        window.db = db;
        window.auth = auth;
        window.appId = appId; // appId'yi de global yapalÄ±m

        // KullanÄ±cÄ± kimlik doÄŸrulama durumu deÄŸiÅŸtiÄŸinde Ã§alÄ±ÅŸacak fonksiyon
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // KullanÄ±cÄ± oturum aÃ§mÄ±ÅŸsa, userId'yi ayarla
                window.userId = user.uid;
                document.getElementById('userIdDisplay').textContent = `KullanÄ±cÄ± ID: ${window.userId}`;
                console.log("Firebase Auth Ready. User ID:", window.userId);
                // KullanÄ±cÄ± oturum aÃ§tÄ±ktan sonra sipariÅŸleri yÃ¼kle
                window.loadOrdersFromFirestore(); // Global fonksiyonu Ã§aÄŸÄ±r
            } else {
                // KullanÄ±cÄ± oturum aÃ§mamÄ±ÅŸsa, anonim olarak oturum aÃ§mayÄ± dene
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    document.getElementById('userIdDisplay').textContent = `Oturum AÃ§Ä±lamadÄ±: ${error.message}`;
                    // Hata durumunda da sipariÅŸleri yÃ¼klemeyi deneyebiliriz, ancak veri kaydedilemez
                    window.loadOrdersFromFirestore(); // Global fonksiyonu Ã§aÄŸÄ±r
                }
            }
        });

        /**
         * SipariÅŸi Firestore'a kaydeder.
         * @param {object} orderData - Kaydedilecek sipariÅŸ verisi.
         */
        window.saveOrderToFirestore = async (orderData) => {
            if (!window.userId) {
                console.warn("KullanÄ±cÄ± kimliÄŸi mevcut deÄŸil, sipariÅŸ kaydedilemiyor.");
                window.showMessage("Hata", "SipariÅŸ kaydedilemedi. LÃ¼tfen internet baÄŸlantÄ±nÄ±zÄ± kontrol edin veya sayfayÄ± yenileyin.", "error");
                return;
            }
            try {
                // KullanÄ±cÄ±ya Ã¶zel koleksiyona kaydet
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${window.userId}/carbonOrders`), {
                    ...orderData,
                    timestamp: serverTimestamp() // Sunucu zaman damgasÄ± ekle
                });
                console.log("SipariÅŸ Firestore'a kaydedildi, ID: ", docRef.id);
            } catch (e) {
                console.error("Firestore'a sipariÅŸ eklenirken hata oluÅŸtu: ", e);
                window.showMessage("Hata", "SipariÅŸ kaydedilirken bir hata oluÅŸtu: " + e.message, "error");
            }
        };

        /**
         * Firestore'dan sipariÅŸleri gerÃ§ek zamanlÄ± olarak yÃ¼kler.
         */
        window.loadOrdersFromFirestore = () => {
            if (!window.userId) {
                console.warn("KullanÄ±cÄ± kimliÄŸi mevcut deÄŸil, sipariÅŸler yÃ¼klenemiyor.");
                return;
            }
            // `orderBy` kullanmaktan kaÃ§Ä±nÄ±yoruz, veriyi Ã§ektikten sonra JS'de sÄ±ralayacaÄŸÄ±z.
            const q = collection(db, `artifacts/${appId}/users/${window.userId}/carbonOrders`);

            onSnapshot(q, (snapshot) => {
                const fetchedOrders = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    // Firestore timestamp objesini okunabilir string'e Ã§evir
                    const timestamp = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString('tr-TR') : 'N/A';
                    fetchedOrders.push({ id: doc.id, ...data, timestamp: timestamp });
                });
                // Global orders dizisini gÃ¼ncelle
                window.orders = fetchedOrders;
                window.displayOrders(); // Global fonksiyonu Ã§aÄŸÄ±r
                console.log("SipariÅŸler Firestore'dan yÃ¼klendi:", fetchedOrders);
            }, (error) => {
                console.error("Firestore'dan sipariÅŸler yÃ¼klenirken hata oluÅŸtu: ", error);
                window.showMessage("Hata", "SipariÅŸler yÃ¼klenirken bir hata oluÅŸtu: " + error.message, "error");
            });
        };

    </script>
    <style>
        /* CSS DeÄŸiÅŸkenleri */
        :root {
            --primary-green: #2E7D32;
            --secondary-green: #4CAF50;
            --light-green: #81C784;
            --accent-green: #66BB6A;
            --dark-green: #1B5E20;
            --success-green: #388E3C;
            --warning-orange: #FF9800;
            --error-red: #D32F2F;
            --text-dark: #212121;
            --text-light: #757575;
            --bg-light: #f8f9fa;
            --shadow: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* Genel Stil AyarlarÄ± */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* BaÅŸlÄ±k BÃ¶lÃ¼mÃ¼ */
        .header {
            background: linear-gradient(135deg, var(--primary-green), var(--secondary-green));
            color: white;
            padding: 40px 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            margin: 10px 0;
            opacity: 0.9;
        }

        .header .logo {
            max-width: 150px; /* Logo boyutunu ayarla */
            height: auto;
            margin-bottom: 15px;
        }
        .user-id-display {
            font-size: 0.85rem;
            margin-top: 10px;
            opacity: 0.7;
        }

        /* Kart Stilleri */
        .card {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-5px);
        }

        .card-header {
            background: linear-gradient(135deg, var(--light-green), var(--accent-green));
            color: white;
            padding: 20px 30px;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .card-body {
            padding: 30px;
        }

        /* Form ElemanlarÄ± */
        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        .form-control, .form-select {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 15px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-green);
            box-shadow: 0 0 0 0.2rem rgba(76, 175, 80, 0.25);
        }

        /* Validasyon Stil SÄ±nÄ±flarÄ± */
        .form-control.is-invalid, .form-select.is-invalid {
            border-color: var(--error-red);
            padding-right: calc(1.5em + .75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23D32F2F'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle r='.5' cx='6' cy='8.2'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(.375em + .1875rem) center;
            background-size: calc(.75em + .375rem) calc(.75em + .375rem);
        }
        .form-control.is-valid, .form-select.is-valid {
            border-color: var(--success-green);
            padding-right: calc(1.5em + .75rem);
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23388E3C' d='M2.3 6.7L0 4.4 1.4 3 2.3 3.9 6.7 0 8.1 1.4z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right calc(.375em + .1875rem) center;
            background-size: calc(.75em + .375rem) calc(.75em + .375rem);
        }

        /* Buton Stilleri */
        .btn {
            border-radius: 12px;
            padding: 12px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary { background: linear-gradient(135deg, var(--secondary-green), var(--success-green)); border: none; color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, var(--success-green), var(--primary-green)); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d, #5a6268); border: none; color: white; }
        .btn-secondary:hover { background: linear-gradient(135deg, #5a6268, #495057); transform: translateY(-2px); }
        .btn-success { background: linear-gradient(135deg, var(--success-green), var(--primary-green)); border: none; }
        .btn-info { background: linear-gradient(135deg, #17a2b8, #138496); border: none; }
        .btn-dark { background: linear-gradient(135deg, #343a40, #23272b); border: none; color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning-orange), #f57c00); border: none; }

        /* Hata MesajlarÄ± ve Animasyon */
        .error { color: var(--error-red); font-size: 0.9rem; margin-top: 5px; display: none; animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .form-check-input:checked { background-color: var(--secondary-green); border-color: var(--secondary-green); }

        /* SonuÃ§ Vurgulama */
        .result-highlight { background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border: 2px solid var(--light-green); border-radius: 15px; padding: 20px; margin: 20px 0; text-align: center; }
        .result-highlight h3 { color: var(--primary-green); font-size: 1.8rem; margin-bottom: 10px; }

        /* Grafik Konteyneri */
        .chart-container { background: white; border-radius: 15px; padding: 20px; box-shadow: var(--shadow); margin: 20px 0; }

        /* Metrik IzgarasÄ± */
        .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: var(--shadow); transition: transform 0.3s ease; }
        .metric-card:hover { transform: translateY(-5px); }
        .metric-value { font-size: 2rem; font-weight: 700; color: var(--primary-green); }
        .metric-label { color: var(--text-light); font-size: 0.9rem; }

        /* SipariÅŸ GeÃ§miÅŸi Ã–ÄŸesi */
        .order-item { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--secondary-green); box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; }
        .order-item:hover { transform: translateX(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }

        /* Uyumluluk Rozeti */
        .compliance-badge { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; }
        .compliance-good { background: linear-gradient(135deg, #4CAF50, #66BB6A); color: white; }
        .compliance-warning { background: linear-gradient(135deg, #FF9800, #FFA726); color: white; }
        .compliance-error { background: linear-gradient(135deg, #F44336, #EF5350); color: white; }

        /* YÃ¼kleme Animasyonu */
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--secondary-green); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* KarÄ±ÅŸÄ±m GiriÅŸ Grubu */
        .blend-input-group { background: #f8f9fa; border-radius: 10px; padding: 15px; margin-bottom: 10px; border-left: 4px solid var(--light-green); }
        
        /* SÃ¼rdÃ¼rÃ¼lebilirlik Skoru Ã‡ubuÄŸu */
        .sustainability-score { background: linear-gradient(135deg, #e8f5e8, #f1f8e9); border-radius: 15px; padding: 20px; margin: 20px 0; }
        .score-bar { width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .score-fill { height: 100%; background: linear-gradient(90deg, var(--error-red), var(--warning-orange), var(--secondary-green)); transition: width 0.5s ease; }
        
        /* Alt Bilgi */
        footer { text-align: center; padding: 30px 0; color: var(--text-light); font-size: 0.9rem; }

        /* DuyarlÄ± TasarÄ±m (Responsive) */
        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header h1 { font-size: 2rem; }
            .card-body { padding: 20px; }
            .metrics-grid { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <img src="RabateksLogo.jpg" alt="Rabateks Logo" class="logo">
            <h1>ğŸŒ± COâ‚‚ TrackIt</h1>
            <p>Green Deal Uyumlu Karbon HesaplayÄ±cÄ±</p>
            <p>Ãœretim sÃ¼reÃ§lerinizin Ã§evresel etkisini hesaplayÄ±n ve sÃ¼rdÃ¼rÃ¼lebilirlik performansÄ±nÄ±zÄ± iyileÅŸtirin</p>
            <p><strong>Rabateks</strong> | <a href="https://rabateks.com" target="_blank" style="color: #fff; text-decoration: underline;">rabateks.com</a></p>
            <p id="userIdDisplay" class="user-id-display">KullanÄ±cÄ± ID: YÃ¼kleniyor...</p>
        </header>

        <div class="card">
            <div class="card-header">ğŸ“Š SipariÅŸ Bilgileri</div>
            <div class="card-body">
                <p class="text-muted">AB YeÅŸil MutabakatÄ± kriterlerine uygun olarak gÃ¼ncellenmiÅŸtir. Geri dÃ¶nÃ¼ÅŸÃ¼m oranÄ± ve Scope 3 emisyonlarÄ± dahildir.</p>
                <form id="carbonForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="orderId" class="form-label">SipariÅŸ ID</label>
                            <input type="text" class="form-control" id="orderId" required>
                            <div class="error" id="orderIdError">SipariÅŸ ID boÅŸ olamaz.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productType" class="form-label">ÃœrÃ¼n Tipi</label>
                            <select class="form-select" id="productType" required>
                                <option value="">ÃœrÃ¼n SeÃ§in</option>
                                <option value="Konfeksiyon">Konfeksiyon</option>
                                <option value="KumaÅŸ">KumaÅŸ</option>
                                <option value="Ä°plik">Ä°plik</option>
                            </select>
                            <div class="error" id="productTypeError">LÃ¼tfen bir Ã¼rÃ¼n tipi seÃ§in.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fabricType" class="form-label">KumaÅŸ Tipi</label>
                            <select class="form-select" id="fabricType">
                                <option value="">KumaÅŸ Tipi SeÃ§in</option>
                                <option value="Dokuma">Dokuma</option>
                                <option value="DÃ¼z Ã–rme">DÃ¼z Ã–rme</option>
                                <option value="Yuvarlak Ã–rme">Yuvarlak Ã–rme</option>
                                <option value="Dokusuz">Dokusuz (Non-woven)</option>
                            </select>
                            <div class="error" id="fabricTypeError">Konfeksiyon veya kumaÅŸ Ã¼rÃ¼nleri iÃ§in kumaÅŸ tipi seÃ§melisiniz.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="material" class="form-label">Hammadde</label>
                            <select class="form-select" id="material" required>
                                <option value="">Hammadde SeÃ§in</option>
                                <option value="PES">PES (Polyester)</option>
                                <option value="rPES">rPES (Geri DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ Polyester)</option>
                                <option value="PA">PA (Polyamid/Naylon)</option>
                                <option value="CO">CO (Pamuk)</option>
                                <option value="rCO">rCO (Geri DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ Pamuk)</option>
                                <option value="WO">WO (YÃ¼n)</option>
                                <option value="PAN">PAN (Akrilik)</option>
                                <option value="PP">PP (Polipropilen)</option>
                                <option value="LI">LI (Keten)</option>
                                <option value="SE">SE (Ä°pek)</option>
                                <option value="VI">VI (Viskoz)</option>
                                <option value="CUP">CUP (Kupro)</option>
                                <option value="CMD">CMD (Modal)</option>
                                <option value="CLY">CLY (Lyocell)</option>
                                <option value="EL">EL (Elastane)</option>
                                <option value="SP">SP (Spandex)</option>
                                <option value="LY">LY (Lycra)</option>
                                <option value="KarÄ±ÅŸÄ±m">KarÄ±ÅŸÄ±m (Ã–zel)</option>
                            </select>
                            <div class="error" id="materialError">LÃ¼tfen bir hammadde seÃ§in.</div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="materialOrigin" class="form-label">Hammadde MenÅŸei</label>
                            <select class="form-select" id="materialOrigin">
                                <option value="TR">TÃ¼rkiye (Yerli)</option>
                                <option value="EU">Avrupa BirliÄŸi</option>
                                <option value="CN">Ã‡in</option>
                                <option value="US">ABD</option>
                                <option value="Other">DiÄŸer</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="productionTech" class="form-label">Ãœretim Teknolojisi</label>
                            <select class="form-select" id="productionTech">
                                <option value="standard">Standart Teknoloji</option>
                                <option value="bat">MÃ¼mkÃ¼n Olan En Ä°yi Teknoloji (BAT)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3" id="blendSection" style="display: none;">
                        <label class="form-label">KarÄ±ÅŸÄ±m OranlarÄ± (%)</label>
                        <div id="blendInputs"></div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addBlendInput()"><i>+</i> Malzeme Ekle</button>
                        <div class="error" id="blendError">Toplam oran %100 olmalÄ±dÄ±r!</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="unit" class="form-label">Birim</label>
                            <select class="form-select" id="unit" required>
                                <option value="">Birim SeÃ§in</option>
                                <option value="Kg">Kg</option>
                                <option value="Mt">Mt (Metre)</option>
                                <option value="Yrd">Yrd (Yarda)</option>
                                <option value="Pcs">Pcs (Adet)</option>
                            </select>
                            <div class="error" id="unitError">LÃ¼tfen bir birim seÃ§in.</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="quantity" class="form-label">Miktar</label>
                            <input type="number" class="form-control" id="quantity" min="0" step="0.01" required>
                            <div class="error" id="quantityError">Miktar pozitif bir sayÄ± olmalÄ±dÄ±r.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ä°ÅŸlem TÃ¼rÃ¼ (Ã‡oklu SeÃ§im)</label>
                        <div class="row">
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processBoyama"><label class="form-check-label" for="processBoyama">Boyama</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processBaski"><label class="form-check-label" for="processBaski">BaskÄ±</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processApre"><label class="form-check-label" for="processApre">Apre</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processDokuma"><label class="form-check-label" for="processDokuma">Dokuma</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processOrme"><label class="form-check-label" for="processOrme">Ã–rme</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processKesim"><label class="form-check-label" for="processKesim">Kesim</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processDikim"><label class="form-check-label" for="processDikim">Dikim</label></div></div>
                            <div class="col-md-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="processBitis"><label class="form-check-label" for="processBitis">BitiÅŸ Ä°ÅŸlemleri</label></div></div>
                        </div>
                        <div class="error" id="processError">LÃ¼tfen en az bir iÅŸlem tÃ¼rÃ¼ seÃ§in.</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="electricity" class="form-label">Elektrik TÃ¼ketimi (kWh)</label><input type="number" class="form-control" id="electricity" min="0" step="0.01"><div class="error" id="electricityError">Elektrik tÃ¼ketimi negatif olamaz.</div></div>
                        <div class="col-md-6 mb-3"><label for="water" class="form-label">Su TÃ¼ketimi (Litre)</label><input type="number" class="form-control" id="water" min="0" step="0.01"><div class="error" id="waterError">Su tÃ¼ketimi negatif olamaz.</div></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="steam" class="form-label">Buhar TÃ¼ketimi (kg)</label><input type="number" class="form-control" id="steam" min="0" step="0.01"><div class="error" id="steamError">Buhar tÃ¼ketimi negatif olamaz.</div></div>
                        <div class="col-md-6 mb-3"><label for="gas" class="form-label">DoÄŸalgaz TÃ¼ketimi (mÂ³)</label><input type="number" class="form-control" id="gas" min="0" step="0.01"><div class="error" id="gasError">DoÄŸalgaz tÃ¼ketimi negatif olamaz.</div></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label for="transport" class="form-label">TaÅŸÄ±ma Mesafesi (km)</label><input type="number" class="form-control" id="transport" min="0" step="0.01"><div class="error" id="transportError">TaÅŸÄ±ma mesafesi negatif olamaz.</div></div>
                        <div class="col-md-6 mb-3"><label for="recycledContent" class="form-label">Geri DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ Ä°Ã§erik (%)</label><input type="number" class="form-control" id="recycledContent" min="0" max="100" step="0.01"><div class="error" id="recycledContentError">Geri dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ iÃ§erik 0 ile 100 arasÄ±nda olmalÄ±dÄ±r.</div><small class="form-text text-muted">AB 2030 hedefi: %50 geri dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ iÃ§erik</small></div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">SÃ¼rdÃ¼rÃ¼lebilir Ä°ÅŸlemler (Ã‡oklu SeÃ§im)</label>
                        <div class="row">
                            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="sustainableWaterless"><label class="form-check-label" for="sustainableWaterless">Su Kullanmayan Boyama</label></div></div>
                            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="sustainableDigital"><label class="form-check-label" for="sustainableDigital">Dijital BaskÄ±</label></div></div>
                            <div class="col-md-4"><div class="form-check"><input class="form-check-input" type="checkbox" id="sustainableRenewable"><label class="form-check-label" for="sustainableRenewable">Yenilenebilir Enerji</label></div></div>
                        </div>
                    </div>
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary me-2">ğŸ” COâ‚‚ EmisyonlarÄ±nÄ± Hesapla</button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">ğŸ”„ SÄ±fÄ±rla</button>
                    </div>
                </form>
                <div class="loading" id="loading"><div class="spinner"></div><p>HesaplanÄ±yor...</p></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ“ˆ Karbon Ayak Ä°zi SonuÃ§larÄ±</div>
            <div class="card-body">
                <div class="result-highlight">
                    <h3>Toplam COâ‚‚ Emisyonu: <span id="totalEmission">0.00 kg</span></h3>
                    <p id="treeEquivalent">Bu miktar, 0 aÄŸacÄ±n bir yÄ±lda temizleyebileceÄŸi COâ‚‚ miktarÄ±na eÅŸdeÄŸerdir.</p>
                </div>
                <div class="metrics-grid">
                    <div class="metric-card"><div class="metric-value" id="electricityEmission">0.00</div><div class="metric-label">Elektrik Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="waterEmission">0.00</div><div class="metric-label">Su Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="steamEmission">0.00</div><div class="metric-label">Buhar Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="gasEmission">0.00</div><div class="metric-label">DoÄŸalgaz Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="transportEmission">0.00</div><div class="metric-label">TaÅŸÄ±ma Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="materialEmission">0.00</div><div class="metric-label">Hammadde Emisyonu (kg)</div></div>
                    <div class="metric-card"><div class="metric-value" id="processEmission">0.00</div><div class="metric-label">Ä°ÅŸlem Emisyonu (kg)</div></div>
                </div>
                <div class="row"><div class="col-md-6"><div class="mb-3"><label for="chartType" class="form-label">Grafik TÃ¼rÃ¼</label><select class="form-select" id="chartType" onchange="window.updateChart()"><option value="bar">Ã‡ubuk Grafik</option><option value="pie">Pasta Grafik</option><option value="doughnut">Halka Grafik</option><option value="line">Ã‡izgi Grafik</option></select></div></div></div>
                <div class="chart-container"><canvas id="emissionChart"></canvas></div>
                <div class="sustainability-score"><h4>ğŸŒ± SÃ¼rdÃ¼rÃ¼lebilirlik Skoru</h4><div class="score-bar"><div class="score-fill" id="sustainabilityBar" style="width: 0%"></div></div><p>SÃ¼rdÃ¼rÃ¼lebilirlik Skoru: <span id="sustainabilityScore">0/100</span></p></div>
                <div class="row">
                    <div class="col-md-6"><h4>ğŸ‡ªğŸ‡º AB Uyumluluk Raporu</h4><p>EU Taxonomy Uyumu: <span id="taxonomyCompliance" class="compliance-badge">HesaplanÄ±yor...</span></p><p>Geri DÃ¶nÃ¼ÅŸÃ¼m Skoru: <span id="recycleScore">0/100</span></p><p><strong>Ã–neriler:</strong> <span id="suggestions">-</span></p></div>
                    <div class="col-md-6"><h4>ğŸ“Š DetaylÄ± Analiz</h4><p>Birim BaÅŸÄ±na Emisyon: <span id="unitEmission">0.00 kg/birim</span></p><p>SektÃ¶r OrtalamasÄ±: <span id="sectorAverage">-</span></p><p>Performans: <span id="performanceRating" class="compliance-badge">-</p></div>
                </div>
                <div class="card mt-4">
                    <div class="card-header" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">ğŸ’¡ SimÃ¼lasyon LaboratuvarÄ±</div>
                    <div class="card-body">
                        <p>FarklÄ± senaryolarÄ±n karbon ayak izinize etkisini anÄ±nda gÃ¶rÃ¼n.</p>
                        <div class="row align-items-center">
                            <div class="col-md-5"><select id="simulationType" class="form-select"><option value="">SimÃ¼lasyon TÃ¼rÃ¼ SeÃ§in</option><option value="recycle">Geri DÃ¶nÃ¼ÅŸÃ¼m OranÄ±nÄ± DeÄŸiÅŸtir</option><option value="energy">Yenilenebilir Enerjiye GeÃ§</option></select></div>
                            <div class="col-md-5"><input type="number" id="simulationValue" class="form-control" placeholder="DeÄŸer Girin (%)" style="display:none;"></div>
                            <div class="col-md-2"><button class="btn btn-info w-100" onclick="window.runSimulation()">SimÃ¼le Et</button></div>
                        </div>
                        <div id="simulationResult" class="result-highlight mt-3" style="display:none; background: linear-gradient(135deg, #e3f2fd, #f1f8e9);"></div>
                    </div>
                </div>
                <div class="text-center my-4">
                    <button class="btn btn-success me-2" onclick="window.exportReport()">ğŸ“„ Raporu DÄ±ÅŸa Aktar</button>
                    <button class="btn btn-info me-2" onclick="window.checkCompliance()">âœ… Uyumluluk KontrolÃ¼</button>
                    <button class="btn btn-warning me-2" onclick="window.generateEUReport()">ğŸ‡ªğŸ‡º AB Raporu</button>
                    <button class="btn btn-dark" onclick="window.generateDPP()">ğŸ“„ Dijital Pasaport OluÅŸtur (JSON)</button>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ—‚ï¸ SipariÅŸ GeÃ§miÅŸi</div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-8"><select class="form-select" id="orderFilter" onchange="window.filterOrders()"><option value="">TÃ¼m SipariÅŸler</option><option value="Konfeksiyon">Konfeksiyon</option><option value="KumaÅŸ">KumaÅŸ</option><option value="Ä°plik">Ä°plik</option><option value="DÃ¼ÅŸÃ¼k Emisyon">DÃ¼ÅŸÃ¼k Emisyon (<50kg)</option><option value="Orta Emisyon">Orta Emisyon (50-200kg)</option><option value="YÃ¼ksek Emisyon">YÃ¼ksek Emisyon (>200kg)</option></select></div>
                    <div class="col-md-4"><button class="btn btn-secondary" onclick="window.resetFilter()">ğŸ”„ Filtreyi SÄ±fÄ±rla</button></div>
                </div>
                <div id="orderHistory"><div class="text-center text-muted"><p>ğŸ” HenÃ¼z hesaplanmÄ±ÅŸ sipariÅŸ yok.</p><p>Ä°lk sipariÅŸinizi eklemek iÃ§in formu doldurun!</p></div></div>
            </div>
        </div>

        <footer>
            <p>Â© 2025 SÃ¼rdÃ¼rÃ¼lebilir Ãœretim Ã‡Ã¶zÃ¼mleri | Rabateks</p>
            <p>ğŸŒ± DÃ¼nya iÃ§in daha yeÅŸil bir gelecek</p>
        </footer>
    </div>

    <!-- Custom Alert Modal -->
    <div class="modal fade" id="customAlertModal" tabindex="-1" aria-labelledby="customAlertModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="customAlertModalLabel">Mesaj</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="customAlertModalBody">
                    <!-- Message content will be inserted here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Tamam</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle (Popper.js ile birlikte) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // Firebase modÃ¼llerini import et
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase ve global deÄŸiÅŸkenlerin tanÄ±mlandÄ±ÄŸÄ±ndan emin ol
        // Bu kÄ±sÄ±m, HTML'in Ã¼st kÄ±smÄ±ndaki <script type="module"> bloÄŸunda tanÄ±mlanan global deÄŸiÅŸkenlere eriÅŸimi saÄŸlar.
        const app = window.firebaseApp;
        const db = window.db;
        const auth = window.auth;
        const appId = window.appId;
        // userId'yi window objesinden alÄ±yoruz
        let userId = window.userId; 

        // Grafik Ã¶rneÄŸi ve sipariÅŸ geÃ§miÅŸi iÃ§in global deÄŸiÅŸkenler
        window.chartInstance = null; // Global yapÄ±ldÄ±
        window.orders = []; // Global yapÄ±ldÄ± ve Firestore'dan yÃ¼klenecek
        // currentEmissionData artÄ±k Ä°ÅŸlemler iÃ§in de bir yer iÃ§eriyor (7 elemanlÄ±)
        window.currentEmissionData = [0, 0, 0, 0, 0, 0, 0]; // Global yapÄ±ldÄ±
        window.currentTotalEmission = 0; // Global yapÄ±ldÄ±

        // Emisyon faktÃ¶rleri ve sektÃ¶r ortalamalarÄ±
        const emissionFactors = {
            electricity: 0.82, // kg CO2e/kWh
            water: 0.001,      // kg CO2e/litre
            steam: 0.184,      // kg CO2e/kg
            gas: 2.016,        // kg CO2e/mÂ³
            transport: 0.21,   // kg CO2e/km (ortalama taÅŸÄ±ma)
            materials: {
                // Her malzeme iÃ§in baz emisyon (kg CO2e/kg malzeme) ve menÅŸe modifikatÃ¶rleri
                PES: { base: 9.52, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                rPES: { base: 4.2, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                PA: { base: 9.6, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                CO: { base: 5.9, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                rCO: { base: 2.1, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                WO: { base: 10.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                PAN: { base: 8.5, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                PP: { base: 3.4, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                LI: { base: 2.1, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                SE: { base: 11.5, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                VI: { base: 5.6, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                CUP: { base: 4.2, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                CMD: { base: 4.1, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                CLY: { base: 2.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                EL: { base: 9.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                SP: { base: 9.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } },
                LY: { base: 9.8, origin_modifier: { TR: 1.0, EU: 0.9, CN: 1.2, US: 1.1, Other: 1.15 } }
            },
            tech_modifier: { standard: 1.0, bat: 0.8 }, // BAT teknolojisi %20 daha az emisyon
            // Yeni eklenen iÅŸlem bazlÄ± emisyon faktÃ¶rleri (kg CO2e / birim miktar)
            process_factors: {
                Boyama: 0.5,   // kg CO2e / birim (Ã¶rn: Kg kumaÅŸ)
                Baski: 0.3,    // kg CO2e / birim
                Apre: 0.2,     // kg CO2e / birim
                Dokuma: 0.4,   // kg CO2e / birim
                Orme: 0.35,    // kg CO2e / birim
                Kesim: 0.1,    // kg CO2e / birim
                Dikim: 0.15,   // kg CO2e / birim
                Bitis: 0.05    // kg CO2e / birim
            }
        };
        const sectorAverages = { 'Konfeksiyon': 15.2, 'KumaÅŸ': 8.7, 'Ä°plik': 12.3 }; // kg CO2e/birim

        /**
         * Belirtilen element iÃ§in hata mesajÄ±nÄ± gÃ¶sterir ve input'u geÃ§ersiz olarak iÅŸaretler.
         * @param {string} elementId - Hata gÃ¶sterilecek HTML elementinin ID'si.
         * @param {string} message - GÃ¶sterilecek hata mesajÄ±.
         */
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            // EÄŸer element doÄŸrudan bir input/select deÄŸilse (Ã¶rn: processError), doÄŸrudan hata mesajÄ± div'ini bul
            const errEl = document.getElementById(`${elementId}Error`) || document.getElementById(elementId); 
            
            if (el && el.tagName) { // input/select ise
                el.classList.add('is-invalid');
                el.classList.remove('is-valid');
            }
            if (errEl) { // Hata mesajÄ± gÃ¶sterecek bir div varsa
                errEl.textContent = message; 
                errEl.style.display = 'block'; 
                // EÄŸer processError gibi bir genel hata div'iyse, ona shake animasyonu ekle
                if (elementId.includes('Error')) {
                    errEl.classList.add('shake-animation'); // CSS'te bu animasyonu tanÄ±mlamanÄ±z gerekebilir
                    setTimeout(() => errEl.classList.remove('shake-animation'), 500);
                }
            }
        }

        /**
         * Belirtilen element iÃ§in hata mesajÄ±nÄ± gizler ve input'un geÃ§ersiz iÅŸaretini kaldÄ±rÄ±r.
         * @param {string} elementId - Hata gizlenecek HTML elementinin ID'si.
         */
        function hideError(elementId) {
            const el = document.getElementById(elementId);
            const errEl = document.getElementById(`${elementId}Error`);

            if (el && el.tagName) {
                el.classList.remove('is-invalid');
            }
            if (errEl) {
                errEl.style.display = 'none';
            }
        }

        /**
         * Belirtilen elementin geÃ§erli olduÄŸunu iÅŸaretler ve hata mesajÄ±nÄ± gizler.
         * @param {string} elementId - GeÃ§erli olarak iÅŸaretlenecek HTML elementinin ID'si.
         */
        function markAsValid(elementId) {
            const el = document.getElementById(elementId);
            if (el && el.tagName) {
                el.classList.remove('is-invalid');
                el.classList.add('is-valid');
            }
            const errEl = document.getElementById(`${elementId}Error`);
            if (errEl) {
                errEl.style.display = 'none';
            }
        }

        /**
         * KarÄ±ÅŸÄ±m hammaddesi seÃ§ildiÄŸinde yeni bir malzeme ve oran giriÅŸ alanÄ± ekler.
         */
        function addBlendInput() {
            const blendInputs = document.getElementById('blendInputs');
            const inputGroup = document.createElement('div');
            inputGroup.className = 'blend-input-group';
            inputGroup.innerHTML = `<div class="row"><div class="col-md-6"><select class="form-select" name="blendMaterial"><option value="">Malzeme SeÃ§in</option><option value="PES">PES</option><option value="rPES">rPES</option><option value="PA">PA</option><option value="CO">CO</option><option value="rCO">rCO</option><option value="WO">WO</option><option value="PAN">PAN</option><option value="PP">PP</option><option value="LI">LI</option><option value="SE">SE</option><option value="VI">VI (Viskoz)</option><option value="CUP">CUP (Kupro)</option><option value="CMD">CMD (Modal)</option><option value="CLY">CLY (Lyocell)</option><option value="EL">EL (Elastane)</option><option value="SP">SP (Spandex)</option><option value="LY">LY (Lycra)</option></select></div><div class="col-md-4"><input type="number" class="form-control" name="blendPercentage" min="0" max="100" placeholder="Oran (%)"></div><div class="col-md-2"><button class="btn btn-danger btn-sm" type="button" onclick="this.parentElement.parentElement.parentElement.remove(); window.validateBlendSum();">ğŸ—‘ï¸ Sil</button></div></div>`;
            blendInputs.appendChild(inputGroup);
            // Yeni eklenen inputlar iÃ§in de change listener ekleyelim ki sum anlÄ±k olarak kontrol edilsin
            const newPercentageInput = inputGroup.querySelector('input[name="blendPercentage"]');
            if (newPercentageInput) {
                newPercentageInput.addEventListener('input', window.validateBlendSum);
            }
            const newMaterialSelect = inputGroup.querySelector('select[name="blendMaterial"]');
            if (newMaterialSelect) {
                newMaterialSelect.addEventListener('change', window.validateBlendSum);
            }
        }

        /**
         * KarÄ±ÅŸÄ±m oranlarÄ±nÄ±n toplamÄ±nÄ±n %100 olup olmadÄ±ÄŸÄ±nÄ± ve malzemelerin seÃ§ili olup olmadÄ±ÄŸÄ±nÄ± kontrol eder.
         * @returns {boolean} - Toplam %100 ve tÃ¼m malzemeler seÃ§iliyse true, aksi takdirde false.
         */
        window.validateBlendSum = function() { // Global yapÄ±ldÄ±
            const blendPercentages = document.querySelectorAll('input[name="blendPercentage"]');
            let totalPercentage = 0;
            let isValidMaterials = true; // TÃ¼m malzemeler seÃ§ili mi?

            blendPercentages.forEach(input => {
                const percentage = parseFloat(input.value);
                if (isNaN(percentage) || percentage < 0 || percentage > 100) {
                    isValidMaterials = false;
                    // showError(input.id, "Oran 0-100 arasÄ±nda olmalÄ±"); // Her input iÃ§in ayrÄ± ayrÄ± hata gÃ¶sterilebilir
                }
                totalPercentage += percentage;
            });

            const blendMaterials = document.querySelectorAll('select[name="blendMaterial"]');
            blendMaterials.forEach(select => {
                if (select.value === '') {
                    isValidMaterials = false;
                    // showError(select.id, "LÃ¼tfen malzeme seÃ§in"); // Her select iÃ§in ayrÄ± ayrÄ± hata gÃ¶sterilebilir
                }
            });

            // EÄŸer hiÃ§ karÄ±ÅŸÄ±m input'u yoksa ve "KarÄ±ÅŸÄ±m" seÃ§iliyse hata ver
            if (blendPercentages.length === 0 && document.getElementById('material').value === 'KarÄ±ÅŸÄ±m') {
                showError('blendError', 'KarÄ±ÅŸÄ±m hammaddesi iÃ§in en az bir malzeme eklemeli ve oranÄ±nÄ± girmelisiniz.');
                return false;
            }
            // EÄŸer karÄ±ÅŸÄ±m input'larÄ± varsa ama toplam %100 deÄŸilse veya malzemeler seÃ§ili deÄŸilse hata ver
            else if (blendPercentages.length > 0 && (totalPercentage !== 100 || !isValidMaterials)) {
                if (totalPercentage !== 100) {
                    showError('blendError', `Toplam oran %100 olmalÄ±dÄ±r! Åu an: ${totalPercentage}%`);
                } else if (!isValidMaterials) {
                    showError('blendError', 'LÃ¼tfen tÃ¼m karÄ±ÅŸÄ±m malzemelerini seÃ§in.');
                }
                return false;
            }
            // Her ÅŸey yolundaysa hatayÄ± gizle
            hideError('blendError');
            // KarÄ±ÅŸÄ±m alanÄ± geÃ§erli olduÄŸunda, tÃ¼m ilgili inputlarÄ± valid olarak iÅŸaretle
            document.querySelectorAll('.blend-input-group .form-control, .blend-input-group .form-select').forEach(el => markAsValid(el.id || el.name));
            return true;
        }

        /**
         * Formu sÄ±fÄ±rlar ve tÃ¼m sonuÃ§ alanlarÄ±nÄ± baÅŸlangÄ±Ã§ durumuna getirir.
         */
        function resetForm() {
            document.getElementById('carbonForm').reset();
            document.getElementById('blendSection').style.display = 'none';
            document.getElementById('blendInputs').innerHTML = '';
            document.querySelectorAll('.error').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.form-control, .form-select, .form-check-input').forEach(el => el.classList.remove('is-invalid', 'is-valid'));
            
            // Checkbox'larÄ±n checked durumunu sÄ±fÄ±rla
            document.querySelectorAll('#carbonForm input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });

            document.getElementById('totalEmission').textContent = '0.00 kg';
            document.getElementById('treeEquivalent').textContent = 'Bu miktar, 0 aÄŸacÄ±n bir yÄ±lda temizleyebileceÄŸi COâ‚‚ miktarÄ±na eÅŸdeÄŸerdir.';
            document.getElementById('taxonomyCompliance').textContent = 'HesaplanÄ±yor...';
            document.getElementById('taxonomyCompliance').className = 'compliance-badge';
            document.getElementById('recycleScore').textContent = '0/100';
            document.getElementById('suggestions').textContent = '-';
            document.getElementById('sustainabilityScore').textContent = '0/100';
            document.getElementById('sustainabilityBar').style.width = '0%';
            document.getElementById('unitEmission').textContent = '0.00 kg/birim';
            document.getElementById('sectorAverage').textContent = '-';
            document.getElementById('performanceRating').textContent = '-';
            document.getElementById('performanceRating').className = 'compliance-badge';
            document.getElementById('simulationResult').style.display = 'none';
            // Ä°ÅŸlem emisyonu iÃ§in de sÄ±fÄ±rlama ekle
            ['electricity', 'water', 'steam', 'gas', 'transport', 'material', 'process'].forEach(type => { document.getElementById(`${type}Emission`).textContent = '0.00'; });
            window.currentEmissionData = [0, 0, 0, 0, 0, 0, 0]; // Global deÄŸiÅŸken
            window.currentTotalEmission = 0; // Global deÄŸiÅŸken
            window.updateChart(); // Global fonksiyonu Ã§aÄŸÄ±r
        }

        /**
         * Emisyon daÄŸÄ±lÄ±m grafiÄŸini gÃ¼nceller.
         */
        window.updateChart = function() { // Global yapÄ±ldÄ±
            const chartType = document.getElementById('chartType').value;
            const ctx = document.getElementById('emissionChart').getContext('2d');
            if (window.chartInstance) { window.chartInstance.destroy(); } // Mevcut grafik Ã¶rneÄŸini yok et
            const config = {
                type: chartType,
                data: {
                    // Etiketlere "Ä°ÅŸlemler" eklendi
                    labels: ['Elektrik', 'Su', 'Buhar', 'DoÄŸalgaz', 'TaÅŸÄ±ma', 'Hammadde', 'Ä°ÅŸlemler'], 
                    datasets: [{ 
                        label: 'COâ‚‚ Emisyonu (kg)', 
                        data: window.currentEmissionData, // Global deÄŸiÅŸken
                        // Yeni kategori iÃ§in renk eklendi
                        backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#A0D9B1'], 
                        borderWidth: 2, 
                        tension: 0.4 
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { position: 'top' }, 
                        title: { display: true, text: 'COâ‚‚ Emisyon DaÄŸÄ±lÄ±mÄ±' } 
                    },
                    scales: chartType !== 'pie' && chartType !== 'doughnut' ? { y: { beginAtZero: true, ticks: { callback: value => value + ' kg' } } } : {}
                }
            };
            window.chartInstance = new Chart(ctx, config); // Global deÄŸiÅŸken
        }

        /**
         * Form gÃ¶nderildiÄŸinde emisyonlarÄ± hesaplar, sonuÃ§larÄ± gÃ¶sterir ve sipariÅŸ geÃ§miÅŸine kaydeder.
         */
        document.getElementById('carbonForm').addEventListener('submit', async function(e) { // async olarak iÅŸaretle
            e.preventDefault(); // Formun varsayÄ±lan gÃ¶nderimini engelle
            document.getElementById('loading').style.display = 'block'; // YÃ¼kleme animasyonunu gÃ¶ster
            let isValid = true; // Formun geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± tutan bayrak

            // TÃ¼m hata mesajlarÄ±nÄ± ve validasyon iÅŸaretlerini sÄ±fÄ±rla
            document.querySelectorAll('.error').forEach(e => e.style.display = 'none');
            document.querySelectorAll('.form-control, .form-select').forEach(el => el.classList.remove('is-invalid', 'is-valid'));

            // Temel alanlarÄ±n validasyonu
            const fields = [
                { id: 'orderId', msg: 'SipariÅŸ ID boÅŸ olamaz.', check: val => val.trim() !== '' },
                { id: 'productType', msg: 'LÃ¼tfen bir Ã¼rÃ¼n tipi seÃ§in.', check: val => val !== '' },
                { id: 'material', msg: 'LÃ¼tfen bir hammadde seÃ§in.', check: val => val !== '' },
                { id: 'unit', msg: 'LÃ¼tfen bir birim seÃ§in.', check: val => val !== '' },
                { id: 'quantity', msg: 'Miktar pozitif bir sayÄ± olmalÄ±dÄ±r.', check: val => parseFloat(val) > 0 }
            ];

            fields.forEach(f => {
                const el = document.getElementById(f.id);
                if (!el || !f.check(el.value)) {
                    showError(f.id, f.msg);
                    isValid = false;
                } else {
                    markAsValid(f.id);
                }
            });

            // SayÄ±sal GiriÅŸler Ä°Ã§in Ek Kontroller (SÄ±fÄ±r veya Pozitif ve Geri DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ Ä°Ã§erik AralÄ±ÄŸÄ±)
            const numericFields = [
                { id: 'electricity', msg: 'Elektrik tÃ¼ketimi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'water', msg: 'Su tÃ¼ketimi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'steam', msg: 'Buhar tÃ¼ketimi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'gas', msg: 'DoÄŸalgaz tÃ¼ketimi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'transport', msg: 'TaÅŸÄ±ma mesafesi negatif olamaz.', check: val => parseFloat(val) >= 0 },
                { id: 'recycledContent', msg: 'Geri dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ iÃ§erik 0 ile 100 arasÄ±nda olmalÄ±dÄ±r.', check: val => parseFloat(val) >= 0 && parseFloat(val) <= 100 }
            ];

            numericFields.forEach(f => {
                const el = document.getElementById(f.id);
                // EÄŸer alan boÅŸsa ve zorunlu deÄŸilse (varsayÄ±lan 0 olarak kabul edeceÄŸiz), valid kabul et
                if (el && el.value.trim() === '') {
                    markAsValid(f.id);
                } else if (el && !f.check(el.value)) { // Sadece el mevcutsa ve geÃ§ersizse hata gÃ¶ster
                    showError(f.id, f.msg);
                    isValid = false;
                } else if (el) { // EÄŸer el mevcutsa ve geÃ§erliyse markAsValid yap
                    markAsValid(f.id);
                }
            });

            // KumaÅŸ Tipi Validasyonu
            const productType = document.getElementById('productType').value;
            const fabricType = document.getElementById('fabricType').value;
            if ((productType === 'Konfeksiyon' || productType === 'KumaÅŸ') && fabricType === '') {
                showError('fabricType', 'Konfeksiyon veya kumaÅŸ Ã¼rÃ¼nleri iÃ§in kumaÅŸ tipi seÃ§melisiniz.');
                isValid = false;
            } else {
                hideError('fabricType'); 
                if(fabricType !== '') { // EÄŸer seÃ§ili ve zorunluluk durumu karÅŸÄ±lanÄ±yorsa markAsValid
                    markAsValid('fabricType');
                } else {
                     // EÄŸer kumaÅŸ tipi seÃ§ilmesi zorunlu deÄŸilse ve boÅŸsa, is-valid durumunu kaldÄ±r
                    document.getElementById('fabricType').classList.remove('is-valid');
                }
            }

            // Ä°ÅŸlem TÃ¼rÃ¼ Validasyonu
            const processCheckboxes = document.querySelectorAll('#carbonForm input[type="checkbox"][id^="process"]');
            const isAnyProcessSelected = Array.from(processCheckboxes).some(checkbox => checkbox.checked);
            if (!isAnyProcessSelected) {
                showError('processError', 'LÃ¼tfen en az bir iÅŸlem tÃ¼rÃ¼ seÃ§in.'); // Hata mesajÄ±nÄ± direkt error div'ine yaz
                isValid = false;
            } else {
                hideError('processError');
            }

            // KarÄ±ÅŸÄ±m OranlarÄ± Validasyonu
            const material = document.getElementById('material').value;
            if (material === 'KarÄ±ÅŸÄ±m') {
                if (!window.validateBlendSum()) { // Global fonksiyonu Ã§aÄŸÄ±r
                    isValid = false;
                }
            }

            // EÄŸer form geÃ§erli deÄŸilse, hesaplamayÄ± durdur
            if (!isValid) {
                document.getElementById('loading').style.display = 'none';
                return;
            }
            
            try {
                // Formdan deÄŸerleri al
                const electricity = parseFloat(document.getElementById('electricity').value) || 0;
                const water = parseFloat(document.getElementById('water').value) || 0;
                const steam = parseFloat(document.getElementById('steam').value) || 0;
                const gas = parseFloat(document.getElementById('gas').value) || 0;
                const transport = parseFloat(document.getElementById('transport').value) || 0;
                const recycledContent = parseFloat(document.getElementById('recycledContent').value) || 0;
                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                const materialOrigin = document.getElementById('materialOrigin').value;
                const productionTech = document.getElementById('productionTech').value;

                // EmisyonlarÄ± hesapla
                const electricityEmission = electricity * emissionFactors.electricity;
                const waterEmission = water * emissionFactors.water;
                const steamEmission = steam * emissionFactors.steam;
                const gasEmission = gas * emissionFactors.gas;
                const transportEmission = transport * emissionFactors.transport;
                
                let materialEmission = 0;
                if (material !== 'KarÄ±ÅŸÄ±m' && emissionFactors.materials[material]) {
                    const matData = emissionFactors.materials[material];
                    materialEmission = (matData.base * (matData.origin_modifier[materialOrigin] || 1.0)) * quantity;
                } else if (material === 'KarÄ±ÅŸÄ±m') {
                    // KarÄ±ÅŸÄ±m hammaddesi hesaplamasÄ±
                    const blendInputs = document.querySelectorAll('#blendInputs .blend-input-group');
                    let blendedMaterialEmissionPerUnit = 0; // Birim baÅŸÄ±na karÄ±ÅŸÄ±m emisyonu
                    blendInputs.forEach(group => {
                        const blendMat = group.querySelector('select[name="blendMaterial"]').value;
                        const blendPct = parseFloat(group.querySelector('input[name="blendPercentage"]').value) || 0;

                        if (blendMat && emissionFactors.materials[blendMat]) {
                            const matData = emissionFactors.materials[blendMat];
                            // Her bir karÄ±ÅŸÄ±m malzemesinin oranÄ±na gÃ¶re emisyonunu topla
                            blendedMaterialEmissionPerUnit += (matData.base * (matData.origin_modifier[materialOrigin] || 1.0)) * (blendPct / 100);
                        }
                    });
                    materialEmission = blendedMaterialEmissionPerUnit * quantity; // Toplam miktar ile Ã§arp
                }

                // Ä°ÅŸlem bazlÄ± emisyonlarÄ± hesapla
                let processEmission = 0;
                const processCheckboxes = document.querySelectorAll('#carbonForm input[type="checkbox"][id^="process"]');
                processCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        // ID'den iÅŸlem adÄ±nÄ± al (Ã¶rn: "Boyama" from "processBoyama")
                        const processKey = checkbox.id.replace('process', ''); 
                        if (emissionFactors.process_factors[processKey]) {
                            processEmission += emissionFactors.process_factors[processKey] * quantity; // Miktar ile Ã§arp
                        }
                    }
                });


                const rawTotal = electricityEmission + waterEmission + steamEmission + gasEmission + transportEmission + materialEmission + processEmission; // Ä°ÅŸlem emisyonu da eklendi
                const techModifier = emissionFactors.tech_modifier[productionTech] || 1.0;
                
                let sustainabilityBonus = 0;
                if (document.getElementById('sustainableWaterless').checked) sustainabilityBonus += 0.05; // %5 azaltma (Ã¶rnek)
                if (document.getElementById('sustainableDigital').checked) sustainabilityBonus += 0.05; // %5 azaltma (Ã¶rnek)
                if (document.getElementById('sustainableRenewable').checked) sustainabilityBonus += 0.10; // %10 azaltma (Ã¶rnek)


                const recyclingBonus = (recycledContent / 100) * 0.30; // Geri dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ iÃ§eriÄŸin emisyonu %30'a kadar azalttÄ±ÄŸÄ±nÄ± varsayalÄ±m

                // Toplam emisyon hesaplamasÄ±: (Ham Toplam * Teknoloji Modifiye) * (1 - SÃ¼rdÃ¼rÃ¼lebilirlik BonuslarÄ± - Geri DÃ¶nÃ¼ÅŸÃ¼m Bonusu)
                // Math.max(0, ...) ile emisyonun negatif olmasÄ±nÄ± engelle
                const totalEmission = rawTotal * techModifier * Math.max(0, (1 - sustainabilityBonus - recyclingBonus));
                window.currentTotalEmission = totalEmission; // Global deÄŸiÅŸken

                // EmisyonlarÄ± gÃ¼ncelle (grafik iÃ§in)
                window.currentEmissionData = [ // Global deÄŸiÅŸken
                    electricityEmission.toFixed(2),
                    waterEmission.toFixed(2),
                    steamEmission.toFixed(2),
                    gasEmission.toFixed(2),
                    transportEmission.toFixed(2),
                    materialEmission.toFixed(2),
                    processEmission.toFixed(2) // Yeni: Ä°ÅŸlem emisyonu
                ];

                // SonuÃ§larÄ± UI'a yaz
                document.getElementById('electricityEmission').textContent = electricityEmission.toFixed(2);
                document.getElementById('waterEmission').textContent = waterEmission.toFixed(2);
                document.getElementById('steamEmission').textContent = steamEmission.toFixed(2);
                document.getElementById('gasEmission').textContent = gasEmission.toFixed(2);
                document.getElementById('transportEmission').textContent = transportEmission.toFixed(2);
                document.getElementById('materialEmission').textContent = materialEmission.toFixed(2);
                document.getElementById('processEmission').textContent = processEmission.toFixed(2); // Yeni: Ä°ÅŸlem emisyonu
                document.getElementById('totalEmission').textContent = `${totalEmission.toFixed(2)} kg`;
                
                const treesEquivalent = (totalEmission / 21.77).toFixed(2); // Bir aÄŸacÄ±n yÄ±lda ortalama 21.77 kg CO2 emdiÄŸi varsayÄ±mÄ±yla
                document.getElementById('treeEquivalent').textContent = `Bu miktar, ${treesEquivalent} aÄŸacÄ±n bir yÄ±lda temizleyebileceÄŸi COâ‚‚ miktarÄ±na eÅŸdeÄŸerdir.`;

                // SÃ¼rdÃ¼rÃ¼lebilirlik Skoru HesaplamasÄ±
                const unitEmission = (quantity > 0 ? totalEmission / quantity : 0);
                const baseScore = 100;
                let scoreDeduction = unitEmission * 5; // Birim baÅŸÄ±na emisyon arttÄ±kÃ§a puan dÃ¼ÅŸsÃ¼n
                if (isNaN(scoreDeduction) || !isFinite(scoreDeduction)) scoreDeduction = 0; // Infinity/NaN kontrolÃ¼
                
                let calculatedSustainabilityScore = baseScore - scoreDeduction + (recycledContent * 0.5); // Geri dÃ¶nÃ¼ÅŸÃ¼m de puanÄ± artÄ±rsÄ±n
                if (document.getElementById('sustainableRenewable').checked) calculatedSustainabilityScore += 10;
                if (document.getElementById('sustainableWaterless').checked) calculatedSustainabilityScore += 5;
                if (document.getElementById('sustainableDigital').checked) calculatedSustainabilityScore += 3;

                calculatedSustainabilityScore = Math.max(0, Math.min(100, calculatedSustainabilityScore)); // 0-100 arasÄ±nda tut

                document.getElementById('sustainabilityScore').textContent = `${calculatedSustainabilityScore.toFixed(0)}/100`;
                document.getElementById('sustainabilityBar').style.width = `${calculatedSustainabilityScore}%`;

                // AB UyumluluÄŸu ve Ã–neriler
                let taxonomyCompliance = 'Uyumsuz';
                let complianceClass = 'compliance-error';
                let suggestions = [];

                if (recycledContent >= 50 && unitEmission < (sectorAverages[productType] || 10) * 0.8) { // SektÃ¶r ortalamasÄ±nÄ±n %80'inden az ise ve geri dÃ¶nÃ¼ÅŸÃ¼m %50 Ã¼zeri ise uyumlu say
                    taxonomyCompliance = 'Uyumlu';
                    complianceClass = 'compliance-good';
                } else if (recycledContent >= 30 || unitEmission < (sectorAverages[productType] || 10)) { // Hafif uyumlu
                    taxonomyCompliance = 'KÄ±smen Uyumlu';
                    complianceClass = 'compliance-warning';
                }

                if (recycledContent < 50) {
                    suggestions.push(`Geri dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ iÃ§erik oranÄ±nÄ± artÄ±rarak AB 2030 hedefine (%50) ulaÅŸÄ±n.`);
                }
                if (unitEmission >= (sectorAverages[productType] || 10) * 0.8) {
                    suggestions.push(`Birim baÅŸÄ±na emisyonu azaltmak iÃ§in Ã¼retim verimliliÄŸini artÄ±rÄ±n veya sÃ¼rdÃ¼rÃ¼lebilir teknolojilere yatÄ±rÄ±m yapÄ±n.`);
                }
                if (!document.getElementById('sustainableRenewable').checked) {
                    suggestions.push(`Yenilenebilir enerji kaynaklarÄ±na geÃ§iÅŸ yapmayÄ± dÃ¼ÅŸÃ¼nÃ¼n.`);
                }
                if (!document.getElementById('sustainableWaterless').checked && document.getElementById('processBoyama').checked) {
                    suggestions.push(`Su kullanmayan boyama tekniklerini araÅŸtÄ±rÄ±n.`);
                }

                document.getElementById('taxonomyCompliance').textContent = taxonomyCompliance;
                document.getElementById('taxonomyCompliance').className = `compliance-badge ${complianceClass}`;
                document.getElementById('recycleScore').textContent = `${recycledContent.toFixed(0)}/100`;
                document.getElementById('suggestions').textContent = suggestions.length > 0 ? suggestions.join(' ') : 'Tebrikler, iyi bir performans sergiliyorsunuz!';

                // DetaylÄ± Analiz
                document.getElementById('unitEmission').textContent = `${unitEmission.toFixed(2)} kg/${document.getElementById('unit').value}`;
                document.getElementById('sectorAverage').textContent = `${(sectorAverages[productType] || 0).toFixed(2)} kg/birim (sektÃ¶r ortalamasÄ±)`;
                
                let performanceRating = '';
                let performanceClass = '';
                const average = sectorAverages[productType] || 0;

                if (unitEmission < average * 0.8) {
                    performanceRating = 'MÃ¼kemmel';
                    performanceClass = 'compliance-good';
                } else if (unitEmission < average * 1.1) {
                    performanceRating = 'Ä°yi';
                    performanceClass = 'compliance-warning';
                } else {
                    performanceRating = 'GeliÅŸtirilmeli';
                    performanceClass = 'compliance-error';
                }
                document.getElementById('performanceRating').textContent = performanceRating;
                document.getElementById('performanceRating').className = `compliance-badge ${performanceClass}`;

                // GÃ¼ncel emisyon verilerini Chart.js iÃ§in hazÄ±rla
                window.currentEmissionData = [ // Global deÄŸiÅŸken
                    electricityEmission.toFixed(2),
                    waterEmission.toFixed(2),
                    steamEmission.toFixed(2),
                    gasEmission.toFixed(2),
                    transportEmission.toFixed(2),
                    materialEmission.toFixed(2),
                    processEmission.toFixed(2) // Yeni: Ä°ÅŸlem emisyonu
                ];
                window.updateChart(); // Global fonksiyonu Ã§aÄŸÄ±r

                // SipariÅŸ objesini oluÅŸtur ve kaydet
                const order = {
                    id: document.getElementById('orderId').value, 
                    productType: document.getElementById('productType').value,
                    fabricType: document.getElementById('fabricType').value,
                    material: material, 
                    materialOrigin: materialOrigin,
                    productionTech: productionTech,
                    quantity: quantity, 
                    unit: document.getElementById('unit').value,
                    electricity: electricity,
                    water: water,
                    steam: steam,
                    gas: gas,
                    transport: transport,
                    recycledContent: recycledContent,
                    processes: Array.from(processCheckboxes).filter(cb => cb.checked).map(cb => cb.labels[0].textContent), // Ä°ÅŸlem tÃ¼rlerinin metinlerini al
                    sustainableProcesses: [
                        document.getElementById('sustainableWaterless').checked ? 'Su Kullanmayan Boyama' : '',
                        document.getElementById('sustainableDigital').checked ? 'Dijital BaskÄ±' : '',
                        document.getElementById('sustainableRenewable').checked ? 'Yenilenebilir Enerji' : ''
                    ].filter(Boolean), // Sadece seÃ§ili olanlarÄ± al
                    emission: totalEmission, 
                    unitEmission: unitEmission,
                    sustainabilityScore: calculatedSustainabilityScore,
                    recycleScore: recycledContent,
                    taxonomyCompliance: taxonomyCompliance,
                    // timestamp: new Date().toLocaleString('tr-TR'), // Firestore'dan serverTimestamp kullanacaÄŸÄ±z
                    emissionBreakdown: { // DetaylÄ± kÄ±rÄ±lÄ±mÄ± da saklayalÄ±m
                        electricity: electricityEmission,
                        water: waterEmission,
                        steam: steamEmission,
                        gas: gasEmission,
                        transport: transportEmission,
                        material: materialEmission,
                        processes: processEmission // Yeni: Ä°ÅŸlem emisyonu
                    }
                };
                // SipariÅŸi Firestore'a kaydet
                await window.saveOrderToFirestore(order);

            } catch (err) {
                console.error("Hesaplama veya kaydetme hatasÄ±:", err);
                window.showMessage("Hata", "Hesaplama veya kaydetme sÄ±rasÄ±nda bir hata oluÅŸtu. LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru girdiÄŸinizden emin olun. Hata: " + err.message, "error");
            } finally {
                document.getElementById('loading').style.display = 'none'; // YÃ¼kleme animasyonunu gizle
            }
        });

        /**
         * KaydedilmiÅŸ sipariÅŸleri gÃ¶rÃ¼ntÃ¼ler ve filtreleme yapar.
         * @param {string} filter - Filtreleme kriteri (Ã¼rÃ¼n tipi veya emisyon aralÄ±ÄŸÄ±).
         */
        window.displayOrders = function(filter = '') { // Global yapÄ±ldÄ±
            const container = document.getElementById('orderHistory');
            if (!window.orders || window.orders.length === 0) { // Global deÄŸiÅŸken
                container.innerHTML = `<div class="text-center text-muted"><p>ğŸ” HenÃ¼z hesaplanmÄ±ÅŸ sipariÅŸ yok.</p><p>Ä°lk sipariÅŸinizi eklemek iÃ§in formu doldurun!</p></div>`; 
                return; 
            }
            let toDisplay = window.orders; // Global deÄŸiÅŸken

            if (filter) {
                if (filter === 'DÃ¼ÅŸÃ¼k Emisyon') {
                    toDisplay = window.orders.filter(o => o.emission < 50);
                } else if (filter === 'Orta Emisyon') {
                    toDisplay = window.orders.filter(o => o.emission >= 50 && o.emission <= 200);
                } else if (filter === 'YÃ¼ksek Emisyon') {
                    toDisplay = window.orders.filter(o => o.emission > 200);
                } else {
                    toDisplay = window.orders.filter(o => o.productType === filter);
                }
            }

            // SipariÅŸleri en yeniye gÃ¶re sÄ±rala (Firestore'dan gelen timestamp'e gÃ¶re)
            toDisplay.sort((a, b) => {
                // Firestore'dan gelen timestamp objesi varsa, onu kullan
                const dateA = a.timestamp instanceof Date ? a.timestamp.getTime() : new Date(a.timestamp).getTime();
                const dateB = b.timestamp instanceof Date ? b.timestamp.getTime() : new Date(b.timestamp).getTime();
                return dateB - dateA;
            });


            container.innerHTML = toDisplay.map(o => `
                <div class="order-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>SipariÅŸ ID:</strong> ${o.id}<br>
                            <strong>ÃœrÃ¼n Tipi:</strong> ${o.productType} ${o.fabricType ? `(${o.fabricType})` : ''}<br>
                            <strong>Hammadde:</strong> ${o.material} (${o.materialOrigin})<br>
                            <strong>Miktar:</strong> ${o.quantity} ${o.unit}<br>
                            <strong>Toplam Emisyon:</strong> <span class="text-danger fw-bold">${o.emission.toFixed(2)} kg COâ‚‚</span>
                        </div>
                        <div>
                            <span class="compliance-badge ${o.taxonomyCompliance === 'Uyumlu' ? 'compliance-good' : (o.taxonomyCompliance === 'KÄ±smen Uyumlu' ? 'compliance-warning' : 'compliance-error')}">${o.taxonomyCompliance}</span><br>
                            <small class="text-muted">${o.timestamp}</small>
                        </div>
                    </div>
                </div>
            `).join('');

            if (toDisplay.length === 0) {
                container.innerHTML = `<div class="text-center text-muted"><p>SeÃ§ilen filtreye uygun sipariÅŸ bulunamadÄ±.</p></div>`;
            }
        }
        
        /**
         * Son hesaplanan sipariÅŸin detaylÄ± raporunu TXT olarak dÄ±ÅŸa aktarÄ±r.
         */
        window.exportReport = function() { // Global yapÄ±ldÄ±
            if (!window.orders || window.orders.length === 0) { window.showMessage("Bilgi", "DÄ±ÅŸa aktarÄ±lacak sipariÅŸ bulunamadÄ±!", "info"); return; } // Global deÄŸiÅŸken
            const lastOrder = window.orders[window.orders.length - 1]; // Global deÄŸiÅŸken
            const reportText = `COâ‚‚ TrackIt Raporu\n\n` +
                               `SipariÅŸ ID: ${lastOrder.id}\n` +
                               `ÃœrÃ¼n Tipi: ${lastOrder.productType}\n` +
                               `KumaÅŸ Tipi: ${lastOrder.fabricType || 'Belirtilmedi'}\n` +
                               `Hammadde: ${lastOrder.material} (${lastOrder.materialOrigin})\n` +
                               `Miktar: ${lastOrder.quantity} ${lastOrder.unit}\n` +
                               `Geri DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ Ä°Ã§erik: %${lastOrder.recycledContent}\n` +
                               `Ãœretim Teknolojisi: ${lastOrder.productionTech === 'bat' ? 'MÃ¼mkÃ¼n Olan En Ä°yi Teknoloji (BAT)' : 'Standart Teknoloji'}\n` +
                               `Uygulanan Ä°ÅŸlemler: ${lastOrder.processes.join(', ') || 'Belirtilmedi'}\n` +
                               `SÃ¼rdÃ¼rÃ¼lebilir Ä°ÅŸlemler: ${lastOrder.sustainableProcesses.join(', ') || 'Yok'}\n\n` +
                               `--- Emisyon DetaylarÄ± ---\n` +
                               `Toplam COâ‚‚ Emisyonu: ${lastOrder.emission.toFixed(2)} kg\n` +
                               `Birim BaÅŸÄ±na Emisyon: ${lastOrder.unitEmission.toFixed(2)} kg/${lastOrder.unit}\n` +
                               `Elektrik Emisyonu: ${lastOrder.emissionBreakdown.electricity.toFixed(2)} kg\n` +
                               `Su Emisyonu: ${lastOrder.emissionBreakdown.water.toFixed(2)} kg\n` +
                               `Buhar Emisyonu: ${lastOrder.emissionBreakdown.steam.toFixed(2)} kg\n` +
                               `DoÄŸalgaz Emisyonu: ${lastOrder.emissionBreakdown.gas.toFixed(2)} kg\n` +
                               `TaÅŸÄ±ma Emisyonu: ${lastOrder.emissionBreakdown.transport.toFixed(2)} kg\n` +
                               `Hammadde Emisyonu: ${lastOrder.emissionBreakdown.material.toFixed(2)} kg\n` +
                               `Ä°ÅŸlem Emisyonu: ${lastOrder.emissionBreakdown.processes.toFixed(2)} kg\n\n` + // Yeni: Ä°ÅŸlem emisyonu
                               `--- SÃ¼rdÃ¼rÃ¼lebilirlik DeÄŸerlendirmesi ---\n` +
                               `SÃ¼rdÃ¼rÃ¼lebilirlik Skoru: ${lastOrder.sustainabilityScore.toFixed(0)}/100\n` +
                               `Geri DÃ¶nÃ¼ÅŸÃ¼m Skoru: ${lastOrder.recycleScore.toFixed(0)}/100\n` +
                               `AB Taxonomy Uyumu: ${lastOrder.taxonomyCompliance}\n` +
                               `Tarih: ${lastOrder.timestamp}\n\n` +
                               `Rabateks COâ‚‚ TrackIt tarafÄ±ndan oluÅŸturulmuÅŸtur.`;
            const blob = new Blob([reportText], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `CO2_Rapor_${lastOrder.id}.txt`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        /**
         * Son hesaplanan sipariÅŸ iÃ§in AB uyumluluk kontrolÃ¼nÃ¼ gÃ¶sterir.
         */
        window.checkCompliance = function() { // Global yapÄ±ldÄ±
            if (!window.orders || window.orders.length === 0) { window.showMessage("Bilgi", "Kontrol edilecek sipariÅŸ bulunamadÄ±!", "info"); return; } // Global deÄŸiÅŸken
            const lastOrder = window.orders[window.orders.length - 1]; // Global deÄŸiÅŸken
            const messages = [`SipariÅŸ ID: ${lastOrder.id} iÃ§in Uyumluluk KontrolÃ¼:\n`];
            messages.push(`- AB YeÅŸil MutabakatÄ± Uyumu: ${lastOrder.taxonomyCompliance}`);
            messages.push(`- Geri DÃ¶nÃ¼ÅŸÃ¼m Skoru: ${lastOrder.recycleScore.toFixed(0)}/100 (Hedef: %50 Ã¼zeri)`);
            messages.push(`- Birim BaÅŸÄ±na Emisyon: ${lastOrder.unitEmission.toFixed(2)} kg/${lastOrder.unit} (SektÃ¶r OrtalamasÄ±: ${(sectorAverages[lastOrder.productType] || 0).toFixed(2)} kg/${lastOrder.unit})`);
            messages.push(`\nÃ–neriler:\n${document.getElementById('suggestions').textContent}`);
            window.showMessage("AB Uyumluluk KontrolÃ¼", messages.join('\n'), "info");
        }

        /**
         * Son hesaplanan sipariÅŸ iÃ§in AB Raporu oluÅŸturur ve gÃ¶sterir.
         */
        window.generateEUReport = function() { // Global yapÄ±ldÄ±
            if (!window.orders || window.orders.length === 0) { window.showMessage("Bilgi", "Rapor oluÅŸturulacak sipariÅŸ bulunamadÄ±!", "info"); return; } // Global deÄŸiÅŸken
            const lastOrder = window.orders[window.orders.length - 1]; // Global deÄŸiÅŸken
            const euReport = `ğŸ‡ªğŸ‡º AVRUPA BÄ°RLÄ°ÄÄ° YEÅÄ°L MUTABAKAT RAPORU\n\n` +
                             `Bu rapor, Rabateks tarafÄ±ndan sunulan COâ‚‚ TrackIt aracÄ± kullanÄ±larak AB YeÅŸil MutabakatÄ± kriterleri doÄŸrultusunda hazÄ±rlanmÄ±ÅŸtÄ±r.\n\n` +
                             `ÃœrÃ¼n Dijital Pasaportu (DPP) Bilgileri:\n` +
                             `  - SipariÅŸ ID: ${lastOrder.id}\n` +
                             `  - ÃœrÃ¼n Tipi: ${lastOrder.productType}\n` +
                             `  - Hammadde: ${lastOrder.material}\n` +
                             `  - Geri DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ Ä°Ã§erik: %${lastOrder.recycledContent}\n` +
                             `  - Toplam COâ‚‚ Emisyonu: ${lastOrder.emission.toFixed(2)} kg\n` +
                             `  - Birim BaÅŸÄ±na COâ‚‚: ${lastOrder.unitEmission.toFixed(2)} kg/${lastOrder.unit}\n` +
                             `  - EU Taxonomy Uyum Durumu: ${lastOrder.taxonomyCompliance}\n` +
                             `  - SÃ¼rdÃ¼rÃ¼lebilirlik Skoru: ${lastOrder.sustainabilityScore.toFixed(0)}/100\n` +
                             `\nDetaylÄ± Emisyon KÄ±rÄ±lÄ±mlarÄ± ve SÃ¼rdÃ¼rÃ¼lebilirlik UygulamalarÄ± bu Ã¼rÃ¼n iÃ§in kaydedilmiÅŸtir.\n` +
                             `Tarih: ${lastOrder.timestamp}\n\n` +
                             `Daha fazla bilgi iÃ§in: rabateks.com`;
            window.showMessage("AB Raporu", euReport, "info");
        }

        /**
         * KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi simÃ¼lasyon tÃ¼rÃ¼ne gÃ¶re emisyonu simÃ¼le eder ve sonucu gÃ¶sterir.
         */
        window.runSimulation = function() { // Global yapÄ±ldÄ±
            if (window.currentTotalEmission <= 0) { window.showMessage("Bilgi", 'LÃ¼tfen Ã¶nce bir hesaplama yapÄ±n.', "info"); return; } // Global deÄŸiÅŸken
            const type = document.getElementById('simulationType').value;
            let value = parseFloat(document.getElementById('simulationValue').value);
            const resultDiv = document.getElementById('simulationResult');
            let simulatedEmission = window.currentTotalEmission; // Global deÄŸiÅŸken
            let simulationText = '';

            if (type === 'recycle') {
                if (isNaN(value) || value < 0 || value > 100) {
                    window.showMessage("Hata", 'Geri dÃ¶nÃ¼ÅŸÃ¼m oranÄ± iÃ§in 0-100 arasÄ±nda bir deÄŸer girin.', "error");
                    return;
                }
                const currentRecycledContent = parseFloat(document.getElementById('recycledContent').value) || 0;
                // Mevcut emisyonu, mevcut geri dÃ¶nÃ¼ÅŸÃ¼m bonusunu Ã§Ä±kararak sÄ±fÄ±rla
                // Bu, bonusun nasÄ±l uygulandÄ±ÄŸÄ±na baÄŸlÄ± olarak deÄŸiÅŸebilir. Basit bir geri alma iÅŸlemi.
                let rawEmissionWithoutRecycleBonus = window.currentTotalEmission / (1 - (currentRecycledContent / 100) * 0.30); // Global deÄŸiÅŸken
                if (isNaN(rawEmissionWithoutRecycleBonus) || !isFinite(rawEmissionWithoutRecycleBonus)) {
                    rawEmissionWithoutRecycleBonus = window.currentTotalEmission; // Hata durumunda deÄŸiÅŸiklik yapma // Global deÄŸiÅŸken
                }

                // Yeni geri dÃ¶nÃ¼ÅŸÃ¼m oranÄ±yla yeniden hesapla
                simulatedEmission = rawEmissionWithoutRecycleBonus * (1 - (value / 100) * 0.30);
                simulationText = `Geri DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ Ä°Ã§erik OranÄ± %${value} olsaydÄ±:<br>` +
                                 `Tahmini Yeni COâ‚‚ Emisyonu: <span class="text-success fw-bold">${simulatedEmission.toFixed(2)} kg</span><br>` +
                                 `%${((window.currentTotalEmission - simulatedEmission) / window.currentTotalEmission * 100).toFixed(2)} azalma.`; // Global deÄŸiÅŸken

            } else if (type === 'energy') {
                // Yenilenebilir enerjiye geÃ§iÅŸ, elektrik emisyonunu Ã¶nemli Ã¶lÃ§Ã¼de azaltÄ±r.
                // Mevcut elektrik emisyonunu bul ve bunu dÃ¼ÅŸÃ¼rerek simÃ¼le et.
                const electricityInput = parseFloat(document.getElementById('electricity').value) || 0;
                const originalElectricityEmission = electricityInput * emissionFactors.electricity;
                
                // Elektrik emisyonu dÄ±ÅŸÄ±ndaki diÄŸer emisyonlarÄ± hesapla
                const nonElectricityEmission = window.currentTotalEmission - originalElectricityEmission; // Global deÄŸiÅŸken
                
                // Yenilenebilir enerji ile elektrik emisyonunu %90 azalttÄ±ÄŸÄ±mÄ±zÄ± varsayalÄ±m
                const newElectricityEmission = originalElectricityEmission * 0.10; // %90 azalma
                
                simulatedEmission = nonElectricityEmission + newElectricityEmission;
                simulationText = `Yenilenebilir Enerjiye tamamen geÃ§iÅŸ yapÄ±lsaydÄ±:<br>` +
                                 `Tahmini Yeni COâ‚‚ Emisyonu: <span class="text-success fw-bold">${simulatedEmission.toFixed(2)} kg</span><br>` +
                                 `%${((window.currentTotalEmission - simulatedEmission) / window.currentTotalEmission * 100).toFixed(2)} azalma.`; // Global deÄŸiÅŸken
            } else {
                window.showMessage("Bilgi", 'LÃ¼tfen bir simÃ¼lasyon tÃ¼rÃ¼ seÃ§in.', "info");
                return;
            }

            resultDiv.innerHTML = `<h5>SimÃ¼lasyon Sonucu:</h5><p>${simulationText}</p>`;
            resultDiv.style.display = 'block';
        }

        /**
         * Son hesaplanan sipariÅŸ iÃ§in Dijital ÃœrÃ¼n Pasaportu (DPP) verisini JSON formatÄ±nda oluÅŸturur ve yeni pencerede gÃ¶sterir.
         */
        window.generateDPP = function() { // Global yapÄ±ldÄ±
            if (!window.orders || window.orders.length === 0) { window.showMessage("Bilgi", 'Pasaport oluÅŸturmak iÃ§in Ã¶nce bir sipariÅŸ hesaplamalÄ±sÄ±nÄ±z.', "info"); return; } // Global deÄŸiÅŸken
            const lastOrder = window.orders[window.orders.length - 1]; // Global deÄŸiÅŸken
            
            // SeÃ§ili iÅŸlem tÃ¼rlerini ve sÃ¼rdÃ¼rÃ¼lebilir iÅŸlemleri al
            const processesSelected = Array.from(document.querySelectorAll('#carbonForm input[type="checkbox"][id^="process"]:checked'))
                                       .map(cb => cb.labels[0].textContent);

            const sustainableProcessesSelected = Array.from(document.querySelectorAll('#carbonForm input[type="checkbox"][id^="sustainable"]:checked'))
                                                    .map(cb => cb.labels[0].textContent);

            const dpp = {
                dpp_id: `urn:uuid:${crypto.randomUUID()}`, // Benzersiz bir ID oluÅŸtur
                product_information: {
                    order_id: lastOrder.id,
                    product_type: lastOrder.productType,
                    fabric_type: lastOrder.fabricType || 'N/A', // KumaÅŸ tipi yoksa N/A
                    material: lastOrder.material,
                    quantity: `${lastOrder.quantity} ${lastOrder.unit}`,
                    material_origin: lastOrder.materialOrigin,
                    recycled_content_percentage: `${lastOrder.recycledContent}%`,
                    production_technology: lastOrder.productionTech,
                    processes_involved: processesSelected,
                    sustainable_practices_applied: sustainableProcessesSelected
                },
                environmental_impact: {
                    total_co2_emission_kg: parseFloat(lastOrder.emission.toFixed(2)),
                    co2_per_unit_kg: parseFloat(lastOrder.unitEmission.toFixed(2)),
                    emission_breakdown_kg: lastOrder.emissionBreakdown,
                    sustainability_score_100: parseFloat(lastOrder.sustainabilityScore.toFixed(0)),
                    recycling_score_100: parseFloat(lastOrder.recycleScore.toFixed(0)),
                    eu_taxonomy_compliance: lastOrder.taxonomyCompliance,
                    tree_equivalent: parseFloat((lastOrder.emission / 21.77).toFixed(2))
                },
                producer_information: {
                    name: "Rabateks",
                    website: "https://rabateks.com",
                    contact: "info@rabateks.com"
                },
                timestamp: lastOrder.timestamp,
                // Ek sertifikasyonlar, test raporlarÄ± vb. buraya eklenebilir
            };
            
            // JSON Ã§Ä±ktÄ±sÄ±nÄ± daha okunaklÄ± hale getirmek iÃ§in yeni bir pencerede gÃ¶sterelim
            const newWindow = window.open();
            newWindow.document.write('<pre>' + JSON.stringify(dpp, null, 2) + '</pre>');
            newWindow.document.title = `DPP - ${lastOrder.id}`;
            newWindow.document.close();

        }

        /**
         * SipariÅŸ geÃ§miÅŸini filtreler.
         */
        window.filterOrders = function() { window.displayOrders(document.getElementById('orderFilter').value); } // Global yapÄ±ldÄ±

        /**
         * SipariÅŸ geÃ§miÅŸi filtresini sÄ±fÄ±rlar.
         */
        window.resetFilter = function() { document.getElementById('orderFilter').value = ''; window.displayOrders(); } // Global yapÄ±ldÄ±

        /**
         * Bootstrap modalÄ±nÄ± kullanarak Ã¶zel bir mesaj gÃ¶sterir.
         * @param {string} title - Modal baÅŸlÄ±ÄŸÄ±.
         * @param {string} message - Modal iÃ§eriÄŸi.
         * @param {string} type - Mesaj tipi (Ã¶rn: 'success', 'error', 'info', 'warning'). Opsiyonel, stil iÃ§in kullanÄ±labilir.
         */
        window.showMessage = function(title, message, type = 'info') {
            const modalElement = document.getElementById('customAlertModal');
            const modalTitle = document.getElementById('customAlertModalLabel');
            const modalBody = document.getElementById('customAlertModalBody');
            
            modalTitle.textContent = title;
            modalBody.innerHTML = message; // HTML iÃ§eriÄŸi de kabul edebiliriz

            // Modal baÅŸlÄ±ÄŸÄ±na ve/veya gÃ¶vdesine tip bazlÄ± sÄ±nÄ±f ekleyebiliriz (isteÄŸe baÄŸlÄ±)
            modalTitle.className = 'modal-title'; // Ã–nceki sÄ±nÄ±flarÄ± temizle
            if (type === 'error') {
                modalTitle.classList.add('text-danger');
            } else if (type === 'success') {
                modalTitle.classList.add('text-success');
            } else if (type === 'warning') {
                modalTitle.classList.add('text-warning');
            } else {
                modalTitle.classList.add('text-primary');
            }

            const modal = new bootstrap.Modal(modalElement);
            modal.show();
        };


        // Olay Dinleyicileri
        document.getElementById('material').addEventListener('change', function() {
            document.getElementById('blendSection').style.display = this.value === 'KarÄ±ÅŸÄ±m' ? 'block' : 'none';
            if (this.value !== 'KarÄ±ÅŸÄ±m') {
                hideError('blendError'); // KarÄ±ÅŸÄ±m seÃ§imi deÄŸiÅŸtiÄŸinde hata mesajÄ±nÄ± gizle
                document.getElementById('blendInputs').innerHTML = ''; // KarÄ±ÅŸÄ±m inputlarÄ±nÄ± temizle
            }
        });

        document.getElementById('simulationType').addEventListener('change', function() {
            document.getElementById('simulationValue').style.display = (this.value === 'recycle') ? 'block' : 'none';
            document.getElementById('simulationValue').value = ''; // SeÃ§im deÄŸiÅŸtiÄŸinde deÄŸeri sÄ±fÄ±rla
            document.getElementById('simulationResult').style.display = 'none'; // SimÃ¼lasyon sonucunu gizle
        });

        // DOM yÃ¼klendiÄŸinde Ã§alÄ±ÅŸacak kod
        document.addEventListener('DOMContentLoaded', () => {
            // userId'nin global olarak ayarlanmasÄ±nÄ± bekleyin
            const checkAuthInterval = setInterval(() => {
                if (window.userId) {
                    clearInterval(checkAuthInterval);
                    window.displayOrders(); // Global fonksiyonu Ã§aÄŸÄ±r
                    window.updateChart(); // Global fonksiyonu Ã§aÄŸÄ±r
                }
            }, 100); // Her 100ms'de bir kontrol et

            // KumaÅŸ Tipi alanÄ±nÄ±n zorunluluÄŸunu Product Type seÃ§imine baÄŸlayalÄ±m
            document.getElementById('productType').addEventListener('change', function() {
                const productType = this.value;
                const fabricTypeSelect = document.getElementById('fabricType');
                if (productType === 'Konfeksiyon' || productType === 'KumaÅŸ') {
                    // Bu durumda zorunlu ama anlÄ±k olarak is-invalid gÃ¶stermeyelim, submit'te kontrol edelim
                    fabricTypeSelect.required = true;
                    // EÄŸer kullanÄ±cÄ± daha Ã¶nce bir seÃ§im yapmadÄ±ysa ve hala boÅŸsa, geÃ§erli sayma durumunu kaldÄ±r
                    if (fabricTypeSelect.value === '') {
                        fabricTypeSelect.classList.remove('is-valid');
                    }
                } else {
                    fabricTypeSelect.required = false;
                    hideError('fabricType'); // Hata mesajÄ±nÄ± gizle
                    fabricTypeSelect.classList.remove('is-invalid', 'is-valid'); // Validasyon iÅŸaretlerini kaldÄ±r
                }
            });
        });
    </script>
</body>
</html>
